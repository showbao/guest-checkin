<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ä¸»æŒäººæ§å°</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    * { box-sizing: border-box; } 
    body { background: #f4f4f4; padding: 20px; font-family: "Microsoft JhengHei", sans-serif; min-height: 100vh; display: flex; flex-direction: column; }
    .container { max-width: 800px; margin: 0 auto; flex: 1; display: flex; flex-direction: column; justify-content: center; }
    
    /* æ¨™é¡Œèˆ‡å°èˆª */
    .top-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
    .school-header { font-weight: 700; color: #6c757d; font-size: 1.1rem; }
    .btn-dashboard { background: #212529; color: white; border: none; padding: 8px 15px; border-radius: 8px; font-weight: bold; display: flex; align-items: center; gap: 5px; cursor: pointer;}
    .btn-dashboard:hover { background: #000; }

    #login-box { background: white; padding: 40px 30px; border-radius: 24px; box-shadow: 0 10px 30px rgba(0,0,0,0.06); max-width: 450px; width: 100%; margin: 0 auto; text-align: center; }
    .input-custom { background-color: #f0f2f5; border: none; border-radius: 12px; padding: 15px; font-size: 1rem; text-align: center; }
    .btn-login { background: #000; color: white; border-radius: 12px; padding: 12px; font-weight: bold; font-size: 1.1rem; width: 100%; margin-top: 20px; }
    
    #main-app { display: none; width: 100%; }
    .event-main-title { font-weight: 800; color: #212529; text-align: center; margin: 0 0 20px 0; line-height: 1.2; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; font-size: clamp(1.8rem, 6vw, 3rem); }
    
    /* æœå°‹æ¡† */
    .search-container { margin-bottom: 20px; }
    .search-box { width: 100%; padding: 15px; border-radius: 12px; border: 2px solid #ddd; font-size: 1.2rem; }

    /* å¡ç‰‡æ¨£å¼ */
    .row-card { 
        border-radius: 12px; padding: 20px 25px; margin-bottom: 12px; display: flex; align-items: center; justify-content: space-between; 
        border: none !important; box-shadow: 0 0 0 1px #e0e0e0, 0 2px 4px rgba(0,0,0,0.05); 
        background: white; min-height: 110px; transition: all 0.3s ease; 
    }
    .level-0 { background: white; } 
    .level-1 { background: #f0fff4; } 
    .level-2 { background: #fffdf5; } 
    .level-3 { background: #fef2f2; } 
    .level-4 { background: #fff; box-shadow: 0 0 0 4px #dc3545, 0 4px 15px rgba(220,53,69,0.3) !important; animation: flashBorder 2s infinite; }
    @keyframes flashBorder { 0% { border-color: #dc3545; } 50% { border-color: #ff8787; } 100% { border-color: #dc3545; } }

    .done { opacity: 0.6; background: #f8f9fa !important; box-shadow: none !important; }
    .done .name { text-decoration: line-through; color: #777; }

    .info { flex: 1; padding: 0 15px; overflow: hidden; min-width: 0; } 
    .job { font-size: 16px; color: #666; display: block; margin-bottom: 4px; }
    .name { font-size: 28px; font-weight: 800; color: #000; display: block; line-height: 1.2; }
    .time { color: #888; font-size: 16px; min-width: 60px; font-weight: 500; }

    .btn-pin { width: 46px; height: 46px; border-radius: 50%; box-shadow: 0 0 0 1px #ddd; background: white; color: #ccc; font-size: 22px; display: flex; align-items: center; justify-content: center; cursor: pointer; margin-right: 12px; }
    .btn-pin.s-level-1 { color: #198754; box-shadow: 0 0 0 1px #198754; } 
    .btn-pin.s-level-2 { color: #ffc107; box-shadow: 0 0 0 1px #ffc107; } 
    .btn-pin.s-level-3 { color: #dc3545; box-shadow: 0 0 0 1px #dc3545; } 
    .btn-pin.s-level-4 { color: #dc3545; box-shadow: 0 0 0 1px #dc3545; background: #ffebeb; }

    .btn-ok { background: #198754; color: white; border: none; padding: 0 25px; border-radius: 10px; font-size: 18px; cursor: pointer; height: 46px; font-weight: bold; }
    .btn-undo { background: #ffc107; color: #000; border: none; padding: 0 15px; border-radius: 10px; font-size: 16px; cursor: pointer; height: 46px; }

    /* === æˆ°æƒ…å®¤ Modal æ¨£å¼ === */
    .dashboard-group { margin-bottom: 30px; }
    .group-title { font-size: 1.2rem; font-weight: bold; padding: 10px; border-bottom: 2px solid #333; margin-bottom: 10px; display: flex; justify-content: space-between; }
    .dash-row { display: flex; align-items: center; padding: 10px; border-bottom: 1px solid #eee; }
    .dash-status { width: 15px; height: 15px; border-radius: 50%; margin-right: 15px; flex-shrink: 0;}
    .st-red { background: #dc3545; } /* æœªåˆ° */
    .st-green { background: #198754; box-shadow: 0 0 5px #198754; } /* å·²åˆ° */
    .st-black { background: #333; opacity: 0.3; } /* å·²ä»‹ç´¹ */
    
    .dash-info { flex: 1; }
    .dash-name { font-weight: bold; font-size: 1.1rem; }
    .dash-job { font-size: 0.9rem; color: #666; margin-right: 10px; }
    .dash-btn { padding: 5px 15px; border-radius: 5px; border: none; font-size: 0.9rem; cursor: pointer; }
    .btn-dash-checkin { background: #0d6efd; color: white; }
    .btn-dash-intro { background: #198754; color: white; }

    @media (max-width: 576px) {
        .row-card { padding: 15px 12px !important; min-height: 90px; }
        .name { font-size: 22px; } 
    }
  </style>
</head>
<body>
<div class="container">
  <div id="login-box">
    <div class="school-header">è¼‰å…¥ä¸­...</div>
    <div class="login-title">ç®¡æ§ç«¯ç™»å…¥</div>
    <input type="password" id="pwd" class="form-control input-custom" placeholder="è«‹è¼¸å…¥å¯†ç¢¼">
    <button onclick="manualLogin()" class="btn btn-login">é€²å…¥ç³»çµ±</button>
  </div>

  <div id="main-app">
    <div class="top-bar">
        <div class="school-header" id="school-header-main"></div>
        <button class="btn-dashboard" onclick="openDashboard()">ğŸ“Š æˆ°æƒ…ç¸½è¦½</button>
    </div>
    
    <h1 id="event-header" class="event-main-title"></h1> 
    
    <div class="search-container">
        <input type="text" id="host-search" class="search-box" placeholder="ğŸ” æœå°‹ç¾å ´ä¾†è³“..." onkeyup="renderSmart()">
    </div>

    <div id="toolbar">
      <div><h3 class="m-0" style="font-weight: 700;">ğŸ¤ ç¾å ´åå–®</h3><small id="last-update" class="text-muted">ç­‰å¾…åŒæ­¥...</small></div>
      <button onclick="manualUpdate()" class="btn btn-primary">ğŸ”„ ç«‹å³æ›´æ–°</button>
    </div>
    
    <div id="list"></div>
  </div>
</div>

<div class="modal fade" id="dashModal" tabindex="-1">
  <div class="modal-dialog modal-fullscreen">
    <div class="modal-content">
      <div class="modal-header bg-dark text-white">
        <h5 class="modal-title">ğŸ“Š æˆ°æƒ…ç¸½è¦½ (VIPåå–®)</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body bg-light" id="dash-body">
        <div class="text-center p-5">è¼‰å…¥ä¸­...</div>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
  // âš ï¸âš ï¸âš ï¸ GAS ç¶²å€ âš ï¸âš ï¸âš ï¸
  const API_URL = "https://script.google.com/macros/s/AKfycbw62YC7Q03CC-YL_UyBKR4JXfP_cU3OIiswA9LlHhKLIS1LJrCg2DBT441eaE880C05BA/exec";
  
  var PASSWORD = ""; var timer = null; var localData = []; var levelNames = {}; var dashModal;

  document.addEventListener("DOMContentLoaded", function() {
    dashModal = new bootstrap.Modal(document.getElementById('dashModal'));
    var storedPwd = sessionStorage.getItem('host_password');
    if (storedPwd) { document.getElementById('pwd').value = storedPwd; setTimeout(manualLogin, 100); }
  });

  function manualLogin() {
    PASSWORD = document.getElementById('pwd').value;
    var btn = document.querySelector('.btn-login'); btn.innerText = "é©—è­‰ä¸­..."; btn.disabled = true;
    
    fetch(API_URL, { method: "POST", body: JSON.stringify({ action: "getHostList", password: PASSWORD }) })
    .then(res => res.json()).then(json => {
      if(json.status === "error") { 
        alert("ç™»å…¥å¤±æ•—"); btn.innerText = "é€²å…¥ç³»çµ±"; btn.disabled = false;
        sessionStorage.removeItem('host_password'); return; 
      }
      document.getElementById('login-box').style.display = 'none';
      document.getElementById('main-app').style.display = 'block';
      document.querySelector('.container').style.justifyContent = 'flex-start';
      
      if(json.settings) {
          if(json.settings.schoolName) {
             document.querySelector('#login-box .school-header').innerText = json.settings.schoolName;
             document.getElementById('school-header-main').innerText = json.settings.schoolName;
          }
          if(json.settings.eventName) document.getElementById('event-header').innerText = json.settings.eventName;
          if(json.settings.levelNames) levelNames = json.settings.levelNames;
      }

      localData = json.data; 
      renderSmart(); 
      startTimer();
    })
    .catch(err => { console.error(err); alert("é€£ç·šéŒ¯èª¤"); btn.innerText = "é€²å…¥ç³»çµ±"; btn.disabled = false; });
  }

  function startTimer() { if(timer) clearInterval(timer); timer = setInterval(fetchData, 5000); }
  function manualUpdate() { fetchData(); startTimer(); }
  function fetchData() {
    var statusLabel = document.getElementById('last-update'); statusLabel.innerText = "æ›´æ–°ä¸­...";
    fetch(API_URL, { method: "POST", body: JSON.stringify({ action: "getHostList", password: PASSWORD }) })
    .then(res => res.json()).then(json => {
      if(json.status === "error") { return; } 
      localData = json.data; renderSmart(); renderDashboard();
      var now = new Date(); statusLabel.innerText = "æœ€å¾Œæ›´æ–°: " + now.toLocaleTimeString();
    });
  }
  
  // ä¸»ç•«é¢ï¼šåªé¡¯ç¤ºç¾å ´è‡ªåŠ©å ±åˆ° (Source=GUEST) çš„å¾…ä»‹ç´¹/å·²ä»‹ç´¹
  function renderSmart() {
    var list = document.getElementById('list'); 
    var keyword = document.getElementById('host-search').value.toLowerCase().trim();

    // éæ¿¾ï¼šåªç•™ GUEST ä¾†æºï¼Œä¸”ç‹€æ…‹éæœªå ±åˆ° (æœªå ±åˆ°çš„ GUEST ä¸å­˜åœ¨)
    // æˆ–æ˜¯ æ–°å ±åˆ°çš„ VIP (Level 4) ä¹Ÿè¦åœ¨ä¸»ç•«é¢é–ƒçˆä¸€ä¸‹æé†’ä¸»æŒäºº? 
    // éœ€æ±‚èªªã€Œä¸»å€åŸŸä¸ç”¨æŠŠé è¨­ä¾†è³“æ··å…¥ã€ï¼Œä½†å¦‚æœ VIP å‰›åˆ°ï¼Œä¸»æŒäººæ‡‰è©²è¦çœ‹åˆ°æé†’ã€‚
    // æŠ˜è¡·ï¼šä¸»ç•«é¢é¡¯ç¤º GUEST + æ‰€æœ‰ Level 4 (æ–°å ±åˆ°)ã€‚
    // èª¿æ•´ï¼šä¾ç…§æ‚¨çš„éœ€æ±‚ã€Œä¸»ç•«é¢æ¯”è¼ƒå–®ç´”ã€ï¼Œé€™è£¡åªæ”¾ GUESTã€‚
    
    var displayData = localData.filter(d => d.source === 'GUEST');

    if (keyword) {
        displayData = displayData.filter(d => d.name.toLowerCase().includes(keyword) || d.title.toLowerCase().includes(keyword));
    }

    displayData.sort((a, b) => {
      if (a.status !== b.status) return a.status === "å¾…ä»‹ç´¹" ? -1 : 1;
      var tA = a.checkInTime || "99:99:99"; var tB = b.checkInTime || "99:99:99";
      if (tA < tB) return -1; if (tA > tB) return 1; return 0; 
    });

    // (ä»¥ä¸‹æ˜¯æ™ºæ…§æ¸²æŸ“é‚è¼¯ï¼Œèˆ‡ä¹‹å‰ç›¸åŒï¼Œç•¥éé‡è¤‡è¨»è§£)
    var html = "";
    if(displayData.length === 0) html = "<div class='text-center p-4 text-muted'>ç„¡ç¾å ´å ±åˆ°åå–®</div>";
    
    // é€™è£¡ç‚ºäº†ç°¡åŒ–ï¼Œä½¿ç”¨å…¨é‡ç¹ª (å› ç‚ºåˆ†æµå¾Œè³‡æ–™é‡å°‘ï¼Œä¸”æˆ°æƒ…å®¤æ‰æ˜¯é‡é»)
    list.innerHTML = "";
    if(displayData.length === 0) { list.innerHTML = html; return; }

    displayData.forEach(item => {
        var isDone = item.status === "å·²ä»‹ç´¹";
        var timeDisplay = item.checkInTime ? item.checkInTime.substring(0, 5) : "";
        var btnHtml = !isDone 
            ? `<button class="btn-ok" onclick="markDone(${item.rowIndex})">ä»‹ç´¹</button>` 
            : `<button class="btn-undo" onclick="undo(${item.rowIndex})">â†©ï¸ å›å¾©</button>`;
        
        // ä¸»ç•«é¢ä¸éœ€è¦æ˜Ÿæ˜Ÿï¼Œå› ç‚ºæ˜¯æµæ°´å¸³
        var card = document.createElement('div');
        card.className = `row-card ${isDone ? 'done' : ''}`;
        card.innerHTML = `<div class="time">${timeDisplay}</div>
          <div class="info"><span class="job">${item.title}</span><span class="name">${item.name}</span></div>
          <div class="d-flex align-items-center">${btnHtml}</div>`;
        list.appendChild(card);
    });
  }

  // --- æˆ°æƒ…å®¤åŠŸèƒ½ ---
  function openDashboard() {
      renderDashboard();
      dashModal.show();
  }

  function renderDashboard() {
      var dashBody = document.getElementById('dash-body');
      // éæ¿¾ï¼šæ’é™¤è‡ªåŠ©å ±åˆ° (GUEST)ï¼Œåªé¡¯ç¤º Sheet åå–® + è£œç™» (RECEPTION)
      var vipData = localData.filter(d => d.source !== 'GUEST');
      
      // åˆ†çµ„ (3, 2, 1, 0)
      var groups = { 3: [], 2: [], 1: [], 0: [] };
      vipData.forEach(d => {
          var lvl = d.originLevel !== undefined ? d.originLevel : 0;
          if(groups[lvl]) groups[lvl].push(d); else groups[0].push(d);
      });

      var html = "";
      // ä¾åºæ¸²æŸ“ Level 3 -> 0
      [3, 2, 1, 0].forEach(lvl => {
          var groupName = levelNames[lvl] || "è²´è³“";
          var items = groups[lvl];
          if(items.length === 0) return;

          html += `<div class="dashboard-group">
            <div class="group-title"><span>${groupName}</span> <span class="badge bg-secondary">${items.length}</span></div>`;
          
          items.forEach(item => {
              var statusClass = "st-red"; // æœªå ±åˆ°
              var btnHtml = `<button class="dash-btn btn-dash-checkin" onclick="receptionCheckIn(${item.rowIndex})">å ±åˆ°</button>`;
              
              if(item.status === "å¾…ä»‹ç´¹") {
                  statusClass = "st-green"; // å·²åˆ°
                  btnHtml = `<button class="dash-btn btn-dash-intro" onclick="markDone(${item.rowIndex})">ä»‹ç´¹</button>`;
              } else if(item.status === "å·²ä»‹ç´¹") {
                  statusClass = "st-black"; // çµæŸ
                  btnHtml = `<small class="text-muted">å·²å®Œæˆ</small>`;
              }

              html += `<div class="dash-row">
                <div class="dash-status ${statusClass}"></div>
                <div class="dash-info"><span class="dash-job">${item.title}</span><span class="dash-name">${item.name}</span></div>
                <div>${btnHtml}</div>
              </div>`;
          });
          html += `</div>`;
      });
      dashBody.innerHTML = html;
  }

  function receptionCheckIn(rowIndex) {
      // æ¨¡æ“¬æ¥å¾…ç«¯å ±åˆ°
      fetch(API_URL, { method: "POST", body: JSON.stringify({ action: "receptionAction", rowIndex: rowIndex, type: "CHECKIN" }) })
      .then(() => fetchData());
  }

  function markDone(rowIndex) {
    var target = localData.find(d => d.rowIndex == rowIndex); 
    if(target) { target.status = "å·²ä»‹ç´¹"; target.priority = 0; }
    renderSmart(); renderDashboard();
    fetch(API_URL, { method: "POST", body: JSON.stringify({ action: "updateStatus", rowIndex: rowIndex, type: "DONE" }) });
  }
  
  function undo(rowIndex) {
    var target = localData.find(d => d.rowIndex == rowIndex); if(target) { target.status = "å¾…ä»‹ç´¹"; }
    renderSmart();
    fetch(API_URL, { method: "POST", body: JSON.stringify({ action: "updateStatus", rowIndex: rowIndex, type: "UNDO" }) });
  }
</script>
</body>
</html>
