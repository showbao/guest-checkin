<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ä¸»æŒäººæ§å°</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    * { box-sizing: border-box; } 
    body { background: #f4f4f4; padding: 20px; font-family: "Microsoft JhengHei", sans-serif; min-height: 100vh; display: flex; flex-direction: column; }
    .container { max-width: 800px; margin: 0 auto; flex: 1; display: flex; flex-direction: column; justify-content: center; }
    
    /* ç™»å…¥èˆ‡æ¨™é¡Œ */
    #login-box { background: white; padding: 40px 30px; border-radius: 24px; box-shadow: 0 10px 30px rgba(0,0,0,0.06); max-width: 450px; width: 100%; margin: 0 auto; text-align: center; }
    .school-header { font-weight: 700; color: #6c757d; margin-bottom: 5px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; font-size: clamp(1rem, 4vw, 1.2rem); text-align: center; }
    .event-main-title { font-weight: 800; color: #212529; text-align: center; margin: 10px 0 20px 0; line-height: 1.2; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; font-size: clamp(1.8rem, 6vw, 3rem); }
    .top-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
    .btn-dashboard { background: #212529; color: white; border: none; padding: 10px 20px; border-radius: 8px; font-weight: bold; display: flex; align-items: center; gap: 5px; cursor: pointer; transition: background 0.2s; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
    .btn-dashboard:hover { background: #000; transform: translateY(-2px); }
    
    .input-custom { background-color: #f0f2f5; border: none; border-radius: 12px; padding: 15px; font-size: 1rem; text-align: center; }
    .btn-login { background: #000; color: white; border-radius: 12px; padding: 12px; font-weight: bold; font-size: 1.1rem; width: 100%; margin-top: 20px; }
    
    #main-app { display: none; width: 100%; }
    
    /* æœå°‹æ¡† */
    .search-container { margin-bottom: 20px; }
    .search-box { width: 100%; padding: 15px; border-radius: 12px; border: 2px solid #ddd; font-size: 1.2rem; transition: border-color 0.3s; }
    .search-box:focus { border-color: #333; outline: none; }
    #toolbar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; border-bottom: 2px solid #e9ecef; padding-bottom: 10px; }

    /* === VIP å¡ç‰‡æ¨£å¼ === */
    .vip-card {
        background: white; border-radius: 12px; padding: 15px; 
        box-shadow: 0 2px 5px rgba(0,0,0,0.05); border: 1px solid #eee;
        display: flex; justify-content: space-between; align-items: center;
        margin-bottom: 10px; transition: all 0.3s;
    }
    .vip-card.is-done { background: #f9f9f9; opacity: 0.6; }
    .vip-card.is-done .vip-name, .vip-card.is-done .vip-job { text-decoration: line-through; color: #999; }

    .vip-info { flex: 1; display: flex; flex-direction: column; justify-content: center; }
    .vip-job { font-size: 0.9rem; color: #666; margin-bottom: 2px; }
    .vip-name { font-weight: 800; font-size: 1.3rem; color: #000; line-height: 1.2;}
    
    .vip-btn { padding: 8px 20px; border-radius: 50px; border: none; font-size: 0.95rem; cursor: pointer; font-weight: bold; min-width: 90px; transition: transform 0.1s;}
    .vip-btn:active { transform: scale(0.95); }
    
    .btn-vip-checkin { background: #dc3545; color: white; } /* ç´…è‰²å¾…å ±åˆ° */
    .btn-vip-intro { background: #198754; color: white; box-shadow: 0 4px 10px rgba(25,135,84,0.3); } /* ç¶ è‰²ä»‹ç´¹ */
    
    .vip-dot { width: 10px; height: 10px; border-radius: 50%; margin-right: 15px; flex-shrink: 0; }
    .dot-red { background: #dc3545; }
    .dot-green { background: #198754; box-shadow: 0 0 5px #198754; }
    .dot-gray { background: #ccc; }

    /* åˆ†å€æ¨™é¡Œ (å¯é»æ“Šæ”¶åˆ) */
    .section-header { 
        padding: 12px 20px; background: #e9ecef; font-weight: bold; color: #555; font-size: 1.1rem;
        display: flex; justify-content: space-between; align-items: center;
        border-left: 5px solid #666; margin-top: 25px; margin-bottom: 15px; border-radius: 0 8px 8px 0;
        cursor: pointer; transition: background 0.2s;
    }
    .section-header:hover { background: #dee2e6; }
    .section-header.active-zone { background: #e8f5e9; border-left-color: #198754; color: #198754; }
    .section-header.active-zone:hover { background: #d1e7dd; }
    
    /* æ”¶åˆç®­é ­å‹•ç•« */
    .collapse-icon { transition: transform 0.3s; }
    .collapsed .collapse-icon { transform: rotate(-90deg); }

    .dash-group-title { font-size: 1rem; color: #333; margin: 15px 5px 10px 5px; font-weight: 900; border-bottom: 2px solid #eee; padding-bottom: 5px;}

    /* === ç¾å ´å ±åˆ°å¡ç‰‡ (å½ˆçª—ç”¨) === */
    .guest-card { 
        border-radius: 12px; padding: 15px 20px; margin-bottom: 12px; display: flex; align-items: center; justify-content: space-between; 
        border: none !important; box-shadow: 0 0 0 1px #e0e0e0, 0 2px 4px rgba(0,0,0,0.05); 
        background: white; min-height: 90px; transition: background-color 0.3s ease; 
    }
    .level-0 { background: white; } .level-1 { background: #f0fff4; } .level-2 { background: #fffdf5; } .level-3 { background: #fef2f2; } 
    .level-4 { background: #fff; box-shadow: 0 0 0 4px #dc3545, 0 4px 15px rgba(220,53,69,0.3) !important; animation: flashBorder 2s infinite; }
    @keyframes flashBorder { 0% { border-color: #dc3545; } 50% { border-color: #ff8787; } 100% { border-color: #dc3545; } }
    .done { opacity: 0.6; background: #f8f9fa !important; box-shadow: none !important; }
    .done .name { text-decoration: line-through; color: #777; }

    .time { color: #888; font-size: 14px; min-width: 50px; text-align: left; font-weight: 500; flex-shrink: 0; }
    .info { flex: 1; padding: 0 15px; overflow: hidden; min-width: 0; } 
    .job { font-size: 14px; color: #666; display: block; margin-bottom: 4px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .name { font-size: 20px; font-weight: 800; color: #000; display: block; line-height: 1.2; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    
    .btn-pin { width: 40px; height: 40px; border-radius: 50%; box-shadow: 0 0 0 1px #ddd; background: white; color: #ccc; font-size: 18px; display: flex; align-items: center; justify-content: center; cursor: pointer; margin-right: 8px; }
    .btn-pin.s-level-1 { color: #198754; box-shadow: 0 0 0 1px #198754; } .btn-pin.s-level-2 { color: #ffc107; box-shadow: 0 0 0 1px #ffc107; } .btn-pin.s-level-3 { color: #dc3545; box-shadow: 0 0 0 1px #dc3545; }
    .btn-ok { background: #198754; color: white; border: none; padding: 0 15px; border-radius: 10px; font-size: 16px; cursor: pointer; height: 40px; font-weight: bold; }
    .btn-undo { background: #ffc107; color: #000; border: none; padding: 0 10px; border-radius: 10px; font-size: 14px; cursor: pointer; height: 40px; }

    /* Modal Header */
    .modal-header { background: #212529; color: white; border-bottom: none; }
    .btn-close-white { filter: invert(1); }

    @media (max-width: 576px) { 
        .row-card { padding: 15px 12px !important; min-height: 90px; } 
        .name { font-size: 22px; } 
        .btn-dashboard { font-size: 0.9rem; padding: 8px 12px; }
    }
  </style>
</head>
<body>
<div class="container">
  <div id="login-box">
    <div class="school-header">è¼‰å…¥ä¸­...</div>
    <div class="login-title">ç®¡æ§ç«¯ç™»å…¥</div>
    <input type="password" id="pwd" class="form-control input-custom" placeholder="è«‹è¼¸å…¥å¯†ç¢¼">
    <button onclick="manualLogin()" class="btn btn-login">é€²å…¥ç³»çµ±</button>
  </div>

  <div id="main-app">
    <div class="top-bar">
        <div class="school-header" id="school-header-main"></div>
        <button class="btn-dashboard" onclick="openGuestModal()">ğŸ“ ç¾å ´å ±åˆ°ä¾†è³“</button>
    </div>
    
    <h1 id="event-header" class="event-main-title"></h1> 
    
    <div class="search-container">
        <input type="text" id="vip-search" class="search-box" placeholder="ğŸ” æœå°‹é è¨­åå–® (é•·å®˜/æ ¡é•·)..." onkeyup="renderMainVIPs()">
    </div>

    <div id="toolbar">
      <div><h3 class="m-0" style="font-weight: 700;">ğŸ‘‘ è²´è³“åå–®</h3><small id="last-update" class="text-muted">ç­‰å¾…åŒæ­¥...</small></div>
      <button onclick="manualUpdate()" class="btn btn-primary">ğŸ”„ ç«‹å³æ›´æ–°</button>
    </div>
    
    <div id="list"></div>
  </div>
</div>

<div class="modal fade" id="guestModal" tabindex="-1">
  <div class="modal-dialog modal-fullscreen">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">ğŸ“ ç¾å ´å ±åˆ°ä¾†è³“ (è‡ªåŠ©ç°½åˆ°)</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body bg-light" style="padding: 20px; overflow-y: auto;">
        <div class="search-container">
            <input type="text" id="guest-search" class="search-box" placeholder="ğŸ” æœå°‹ç¾å ´å ±åˆ°è€…..." onkeyup="renderGuestModal()">
        </div>
        <div id="guest-list-body">
            <div class="text-center p-5">è¼‰å…¥ä¸­...</div>
        </div>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
  // âš ï¸âš ï¸âš ï¸ è¨˜å¾—ç¢ºèª GAS ç¶²å€ âš ï¸âš ï¸âš ï¸
  const API_URL = "https://script.google.com/macros/s/AKfycbw62YC7Q03CC-YL_UyBKR4JXfP_cU3OIiswA9LlHhKLIS1LJrCg2DBT441eaE880C05BA/exec";
  
  var PASSWORD = ""; var timer = null; var localData = []; var levelNames = {}; var guestModal;
  var isProcessing = false; // ğŸ”’ å¯«å…¥é–å®š

  document.addEventListener("DOMContentLoaded", function() {
    guestModal = new bootstrap.Modal(document.getElementById('guestModal'));
    var storedPwd = sessionStorage.getItem('host_password');
    if (storedPwd) { document.getElementById('pwd').value = storedPwd; setTimeout(manualLogin, 100); }
  });

  function manualLogin() {
    PASSWORD = document.getElementById('pwd').value;
    var btn = document.querySelector('.btn-login'); btn.innerText = "é©—è­‰ä¸­..."; btn.disabled = true;
    
    fetch(API_URL, { method: "POST", body: JSON.stringify({ action: "getHostList", password: PASSWORD }) })
    .then(res => res.json()).then(json => {
      if(json.status === "error") { 
        alert("ç™»å…¥å¤±æ•—ï¼š" + json.message); btn.innerText = "é€²å…¥ç³»çµ±"; btn.disabled = false;
        sessionStorage.removeItem('host_password'); return; 
      }
      document.getElementById('login-box').style.display = 'none';
      document.getElementById('main-app').style.display = 'block';
      document.querySelector('.container').style.justifyContent = 'flex-start';
      
      if(json.settings) {
          if(json.settings.schoolName) {
             document.querySelector('#login-box .school-header').innerText = json.settings.schoolName;
             document.getElementById('school-header-main').innerText = json.settings.schoolName;
          }
          if(json.settings.eventName) document.getElementById('event-header').innerText = json.settings.eventName;
          
          if(json.settings.levelNames) {
              levelNames = json.settings.levelNames;
          } else {
              levelNames = json.settings;
          }
      }

      localData = json.data; 
      renderMainVIPs(); 
      startTimer();
    })
    .catch(err => { console.error(err); alert("é€£ç·šéŒ¯èª¤"); btn.innerText = "é€²å…¥ç³»çµ±"; btn.disabled = false; });
  }

  function startTimer() { if(timer) clearInterval(timer); timer = setInterval(fetchData, 5000); }
  function manualUpdate() { fetchData(); startTimer(); }
  
  function fetchData() {
    if(isProcessing) return;

    var statusLabel = document.getElementById('last-update'); statusLabel.innerText = "æ›´æ–°ä¸­...";
    fetch(API_URL, { method: "POST", body: JSON.stringify({ action: "getHostList", password: PASSWORD }) })
    .then(res => res.json()).then(json => {
      if(isProcessing) return;

      if(json.status === "error") { return; } 
      localData = json.data; 
      renderMainVIPs(); 
      if(document.getElementById('guestModal').classList.contains('show')) {
          renderGuestModal();
      }
      var now = new Date(); statusLabel.innerText = "æœ€å¾Œæ›´æ–°: " + now.toLocaleTimeString();
    });
  }
  
  // ==========================================
  // 1. ä¸»ç•«é¢æ¸²æŸ“ï¼šVIP åå–® (ä¸‰å€å¡Šåˆ†æµ)
  // ==========================================
  function renderMainVIPs() {
      var list = document.getElementById('list');
      var keyword = document.getElementById('vip-search').value.toLowerCase().trim();
      
      var vipData = localData.filter(d => d.source !== 'GUEST');
      
      if (keyword) {
          vipData = vipData.filter(d => d.name.toLowerCase().includes(keyword) || d.title.toLowerCase().includes(keyword));
      }

      // åˆ†å€ï¼š1.å·²åˆ°(å¾…ä»‹ç´¹), 2.æœªå ±åˆ°(å¾…å ±åˆ°), 3.å·²ä»‹ç´¹
      var activeData = vipData.filter(d => d.status === "å¾…ä»‹ç´¹");
      var pendingData = vipData.filter(d => d.status === "æœªå ±åˆ°");
      var doneData = vipData.filter(d => d.status === "å·²ä»‹ç´¹");

      var html = "";

      // --- Section 1: å·²åˆ°ç¾å ´ (å¾…ä»‹ç´¹) - é è¨­å±•é–‹ ---
      html += createSectionHtml("active", "ğŸ“£ å·²åˆ°ç¾å ´ (å¾…ä»‹ç´¹)", activeData, "show", "active-zone");

      // --- Section 2: å¾…å ±åˆ° (å°šæœªåˆ°æ ¡) - é è¨­æ”¶åˆ ---
      html += createSectionHtml("pending", "ğŸ›‘ å¾…å ±åˆ° (å°šæœªåˆ°æ ¡)", pendingData, "", "");

      // --- Section 3: å·²ä»‹ç´¹ - é è¨­æ”¶åˆ ---
      html += createSectionHtml("done", "âš« å·²ä»‹ç´¹", doneData, "", "");

      list.innerHTML = html;
  }

  function createSectionHtml(type, title, data, showClass, headerClass) {
      var count = data.length;
      var html = `
        <div class="section-header ${headerClass}" data-bs-toggle="collapse" data-bs-target="#collapse-${type}">
            <span>${title} <span class="badge bg-secondary ms-2">${count}</span></span>
            <span class="collapse-icon">â–¼</span>
        </div>
        <div id="collapse-${type}" class="collapse ${showClass}">
      `;

      if(data.length === 0) {
          html += `<div class="text-center p-3 text-muted">ç„¡è³‡æ–™</div>`;
      } else {
          // æ’åº: ç­‰ç´šé«˜->ä½ > å ±åˆ°æ™‚é–“æ—©->æ™š (æˆ– Sheet é †åº)
          data.sort((a, b) => {
              var lvlA = a.originLevel || 0; var lvlB = b.originLevel || 0;
              if (lvlA !== lvlB) return lvlB - lvlA;
              
              if (type === 'pending') return a.rowIndex - b.rowIndex; // æœªå ±åˆ°ä¾ Sheet é †åº
              
              var tA = a.checkInTime || "99:99:99"; var tB = b.checkInTime || "99:99:99";
              if (tA < tB) return -1; if (tA > tB) return 1; return 0;
          });
          
          html += `<div class="row g-2">`;
          [3, 2, 1, 0].forEach(lvl => {
              var items = data.filter(d => (d.originLevel || 0) === lvl);
              if (items.length > 0) {
                  var groupName = (levelNames && levelNames[lvl]) ? levelNames[lvl] : "è²´è³“";
                  html += `<div class="col-12"><div class="dash-group-title">${groupName}</div></div>`;
                  items.forEach(item => html += createVipCard(item));
              }
          });
          html += `</div>`;
      }
      html += `</div>`; // End collapse
      return html;
  }

  function createVipCard(item) {
      var dotClass, btnHtml, cardClass = "vip-card";
      
      if (item.status === "æœªå ±åˆ°") {
          dotClass = "dot-red";
          btnHtml = `<button class="vip-btn btn-vip-checkin" onclick="vipAction(${item.rowIndex}, 'CHECKIN')">å¾…å ±åˆ°</button>`;
      } else if (item.status === "å¾…ä»‹ç´¹") {
          dotClass = "dot-green";
          // æŒ‰éˆ•æ–‡å­—æ”¹ç‚ºã€Œå¾…ä»‹ç´¹ã€
          btnHtml = `<button class="vip-btn btn-vip-intro" onclick="vipAction(${item.rowIndex}, 'DONE')">å¾…ä»‹ç´¹</button>`;
      } else { // å·²ä»‹ç´¹
          dotClass = "dot-gray";
          cardClass += " is-done";
          btnHtml = `<small class="text-muted fw-bold">å·²å®Œæˆ</small>`;
      }

      return `<div class="col-12 col-md-6">
          <div class="${cardClass}">
            <div class="d-flex align-items-center">
                <div class="vip-dot ${dotClass}"></div>
                <div class="vip-info">
                    <span class="vip-job">${item.title}</span>
                    <span class="vip-name">${item.name}</span>
                </div>
            </div>
            <div>${btnHtml}</div>
          </div>
      </div>`;
  }

  // â˜…â˜…â˜… VIP å‹•ä½œè™•ç† (å«é˜²é–ƒçˆ) â˜…â˜…â˜…
  function vipAction(rowIndex, actionType) {
      if(timer) clearInterval(timer);
      isProcessing = true; // é–å®š

      var target = localData.find(d => d.rowIndex == rowIndex);
      if (!target) return;

      // Optimistic UI
      if (actionType === 'CHECKIN') {
          target.status = "å¾…ä»‹ç´¹";
          var now = new Date(); target.checkInTime = now.toTimeString().split(' ')[0];
      } else if (actionType === 'DONE') {
          target.status = "å·²ä»‹ç´¹";
      }

      renderMainVIPs();

      var postAction = (actionType === 'CHECKIN') ? 'receptionAction' : 'updateStatus';
      var postType = (actionType === 'CHECKIN') ? 'CHECKIN' : 'DONE';

      fetch(API_URL, { 
          method: "POST", 
          body: JSON.stringify({ action: postAction, rowIndex: rowIndex, type: postType }) 
      })
      .then(() => {
          setTimeout(() => {
             isProcessing = false; // è§£é–
             fetchData(); // é‡æ–°æ‹‰å–
             startTimer(); // é‡å•Ÿ Timer
          }, 2500); 
      })
      .catch(err => {
          console.error(err); alert("é€£ç·šç•°å¸¸"); isProcessing = false; startTimer();
      });
  }

  // ==========================================
  // 2. å½ˆçª—æ¸²æŸ“ï¼šç¾å ´å ±åˆ°ä¾†è³“ (è‡ªåŠ©ç°½åˆ°)
  // ==========================================
  function openGuestModal() {
      renderGuestModal();
      guestModal.show();
  }

  function renderGuestModal() {
      var list = document.getElementById('guest-list-body');
      var keyword = document.getElementById('guest-search').value.toLowerCase().trim();
      
      var guestData = localData.filter(d => d.source === 'GUEST');

      if (keyword) {
          guestData = guestData.filter(d => d.name.toLowerCase().includes(keyword) || d.title.toLowerCase().includes(keyword));
      }

      // æ’åº: å¾…ä»‹ç´¹ > æ˜Ÿæ˜Ÿ > æ™‚é–“
      guestData.sort((a, b) => {
        if (a.status !== b.status) return a.status === "å¾…ä»‹ç´¹" ? -1 : 1;
        var pA = a.priority || 0; var pB = b.priority || 0;
        if (pA !== pB) return pB - pA;
        var tA = a.checkInTime || "99:99:99"; var tB = b.checkInTime || "99:99:99";
        if (tA < tB) return -1; if (tA > tB) return 1; return 0; 
      });

      var html = "";
      if(guestData.length === 0) html = "<div class='text-center p-4 text-muted'>ç„¡ç¾å ´å ±åˆ°åå–®</div>";
      else {
          guestData.forEach(item => {
            var isDone = item.status === "å·²ä»‹ç´¹";
            var pLevel = item.priority || 0;
            var timeDisplay = item.checkInTime ? item.checkInTime.substring(0, 5) : "";
            var btnHtml = !isDone 
                ? `<div class="btn-pin s-level-${pLevel}" onclick="cycleGuestPriority(${item.rowIndex})">â˜…</div><button class="btn-ok" onclick="markGuestDone(${item.rowIndex})">ä»‹ç´¹</button>` 
                : `<button class="btn-undo" onclick="undoGuest(${item.rowIndex})">â†©ï¸ å›å¾©</button>`;
            
            html += `<div class="guest-card level-${pLevel} ${isDone ? 'done' : ''}">
              <div class="time">${timeDisplay}</div>
              <div class="info"><span class="job">${item.title}</span><span class="name">${item.name}</span></div>
              <div class="d-flex align-items-center">${btnHtml}</div>
            </div>`;
          });
      }
      list.innerHTML = html;
  }

  // â˜…â˜…â˜… ç¾å ´ä¾†è³“å‹•ä½œ (Modal å…§) â˜…â˜…â˜…
  function cycleGuestPriority(rowIndex) {
      var target = localData.find(d => d.rowIndex == rowIndex);
      if(target) {
          var newP = ((target.priority || 0) + 1) % 4;
          target.priority = newP;
          renderGuestModal(); 
          if(timer) clearInterval(timer); 
          fetch(API_URL, { method: "POST", body: JSON.stringify({ action: "updateStatus", rowIndex: rowIndex, type: "PIN" }) });
          setTimeout(startTimer, 3000); 
      }
  }

  function markGuestDone(rowIndex) {
      var target = localData.find(d => d.rowIndex == rowIndex);
      if(target) { target.status = "å·²ä»‹ç´¹"; target.priority = 0; }
      renderGuestModal();
      fetch(API_URL, { method: "POST", body: JSON.stringify({ action: "updateStatus", rowIndex: rowIndex, type: "DONE" }) });
  }

  function undoGuest(rowIndex) {
      var target = localData.find(d => d.rowIndex == rowIndex);
      if(target) { target.status = "å¾…ä»‹ç´¹"; }
      renderGuestModal();
      fetch(API_URL, { method: "POST", body: JSON.stringify({ action: "updateStatus", rowIndex: rowIndex, type: "UNDO" }) });
  }
</script>
</body>
</html>
