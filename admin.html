<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ä¸»æŒäººæ§å°</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    * { box-sizing: border-box; } 
    body { background: #f4f4f4; padding: 20px; font-family: "Microsoft JhengHei", sans-serif; min-height: 100vh; display: flex; flex-direction: column; }
    .container { max-width: 800px; margin: 0 auto; flex: 1; display: flex; flex-direction: column; justify-content: center; }
    
    #login-box { background: white; padding: 40px 30px; border-radius: 24px; box-shadow: 0 10px 30px rgba(0,0,0,0.06); max-width: 450px; width: 100%; margin: 0 auto; text-align: center; }
    .school-header { font-weight: 700; color: #6c757d; margin-bottom: 5px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; font-size: clamp(1rem, 4vw, 1.2rem); text-align: center; }
    .event-main-title { font-weight: 800; color: #212529; text-align: center; margin: 10px 0 20px 0; line-height: 1.2; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; font-size: clamp(1.8rem, 6vw, 3rem); }
    
    /* æœå°‹æ¡†æ¨£å¼ */
    .search-container { margin-bottom: 20px; }
    .search-box { width: 100%; padding: 15px; border-radius: 12px; border: 2px solid #ddd; font-size: 1.2rem; transition: border-color 0.3s; }
    .search-box:focus { border-color: #333; outline: none; }

    .login-title { font-size: 1.5rem; font-weight: 800; color: #333; margin-bottom: 30px; }
    .input-custom { background-color: #f0f2f5; border: none; border-radius: 12px; padding: 15px; font-size: 1rem; text-align: center; }
    .btn-login { background: #000; color: white; border-radius: 12px; padding: 12px; font-weight: bold; font-size: 1.1rem; width: 100%; margin-top: 20px; }
    
    #main-app { display: none; width: 100%; }
    
    .row-card { 
        border-radius: 12px; padding: 20px 25px; margin-bottom: 12px; display: flex; align-items: center; justify-content: space-between; 
        border: none !important; box-shadow: 0 0 0 1px #e0e0e0, 0 2px 4px rgba(0,0,0,0.05); 
        background: white; min-height: 110px; transition: background-color 0.3s ease, box-shadow 0.3s ease; 
    }
    
    /* æ¬Šé‡æ¨£å¼ */
    .level-0 { background: white; } 
    .level-1 { background: #f0fff4; } 
    .level-2 { background: #fffdf5; } 
    .level-3 { background: #fef2f2; } 
    .level-4 { background: #fff; box-shadow: 0 0 0 4px #dc3545, 0 4px 15px rgba(220,53,69,0.3) !important; animation: flashBorder 2s infinite; }
    @keyframes flashBorder { 0% { border-color: #dc3545; } 50% { border-color: #ff8787; } 100% { border-color: #dc3545; } }

    .done { opacity: 0.6; background: #f8f9fa !important; box-shadow: none !important; }
    .done .name { text-decoration: line-through; color: #777; }

    .time { color: #888; font-size: 16px; min-width: 60px; text-align: left; font-weight: 500; flex-shrink: 0; }
    .info { flex: 1; padding: 0 15px; overflow: hidden; min-width: 0; } 
    .job { font-size: 16px; color: #666; display: block; margin-bottom: 4px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .name { font-size: 28px; font-weight: 800; color: #000; display: block; line-height: 1.2; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    
    .btn-pin { width: 46px; height: 46px; border-radius: 50%; border: none !important; box-shadow: 0 0 0 1px #ddd; background: white; color: #ccc; font-size: 22px; display: flex; align-items: center; justify-content: center; cursor: pointer; margin-right: 12px; flex-shrink: 0; outline: none; transition: all 0.2s; }
    .btn-pin.s-level-1 { color: #198754; box-shadow: 0 0 0 1px #198754; } 
    .btn-pin.s-level-2 { color: #ffc107; box-shadow: 0 0 0 1px #ffc107; } 
    .btn-pin.s-level-3 { color: #dc3545; box-shadow: 0 0 0 1px #dc3545; } 
    .btn-pin.s-level-4 { color: #dc3545; box-shadow: 0 0 0 1px #dc3545; background: #ffebeb; }

    .btn-ok { background: #198754; color: white; border: none; padding: 0 25px; border-radius: 10px; font-size: 18px; cursor: pointer; height: 46px; font-weight: bold; flex-shrink: 0; transition: transform 0.1s; }
    .btn-ok:active { transform: scale(0.95); }
    .btn-undo { background: #ffc107; color: #000; border: none; padding: 0 15px; border-radius: 10px; font-size: 16px; cursor: pointer; height: 46px; flex-shrink: 0; }
    #toolbar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; border-bottom: 2px solid #e9ecef; padding-bottom: 10px; }

    @media (max-width: 576px) {
        body { padding: 10px; }
        .row-card { padding: 15px 12px !important; min-height: 90px; }
        .btn-pin { width: 40px; height: 40px; font-size: 18px; margin-right: 8px; }
        .btn-ok { height: 40px; padding: 0 15px; font-size: 15px; }
        .btn-undo { height: 40px; padding: 0 10px; font-size: 14px; }
        .time { min-width: 50px; font-size: 14px; }
        .info { padding: 0 10px; }
        .name { font-size: 22px; } 
        .job { font-size: 14px; }
    }
  </style>
</head>
<body>
<div class="container">
  <div id="login-box">
    <div class="school-header">è¼‰å…¥ä¸­...</div>
    <div class="login-title">ç®¡æ§ç«¯ç™»å…¥</div>
    <input type="password" id="pwd" class="form-control input-custom" placeholder="è«‹è¼¸å…¥å¯†ç¢¼">
    <button onclick="manualLogin()" class="btn btn-login">é€²å…¥ç³»çµ±</button>
  </div>
  <div id="main-app">
    <div class="school-header" id="school-header-main" style="margin-top: 20px;"></div>
    <h1 id="event-header" class="event-main-title"></h1> 
    
    <div class="search-container">
        <input type="text" id="host-search" class="search-box" placeholder="ğŸ” å¿«é€Ÿæœå°‹ç¾å ´åå–®..." onkeyup="renderSmart()">
    </div>

    <div id="toolbar">
      <div><h3 class="m-0" style="font-weight: 700;">ğŸ¤ ç¾å ´åå–®</h3><small id="last-update" class="text-muted">ç­‰å¾…åŒæ­¥...</small></div>
      <button onclick="manualUpdate()" class="btn btn-primary">ğŸ”„ ç«‹å³æ›´æ–°</button>
    </div>
    <div id="list"></div>
  </div>
</div>
<script>
  // âš ï¸âš ï¸âš ï¸ è¨˜å¾—ç¢ºèª GAS ç¶²å€ âš ï¸âš ï¸âš ï¸
  const API_URL = "https://script.google.com/macros/s/AKfycbw62YC7Q03CC-YL_UyBKR4JXfP_cU3OIiswA9LlHhKLIS1LJrCg2DBT441eaE880C05BA/exec";
  
  var PASSWORD = ""; 
  var timer = null; 
  var localData = []; 
  var debounceTimer = null; 

  document.addEventListener("DOMContentLoaded", function() {
    var storedPwd = sessionStorage.getItem('host_password');
    if (storedPwd) {
      document.getElementById('pwd').value = storedPwd;
      setTimeout(manualLogin, 100); 
    }
  });

  function manualLogin() {
    PASSWORD = document.getElementById('pwd').value;
    var btn = document.querySelector('.btn-login'); btn.innerText = "é©—è­‰ä¸­..."; btn.disabled = true;
    
    fetch(API_URL, { method: "POST", body: JSON.stringify({ action: "getHostList", password: PASSWORD }) })
    .then(res => res.json()).then(json => {
      if(json.status === "error") { 
        alert("ç™»å…¥å¤±æ•—ï¼š" + json.message); 
        btn.innerText = "é€²å…¥ç³»çµ±"; btn.disabled = false;
        sessionStorage.removeItem('host_password');
        return; 
      }
      
      document.getElementById('login-box').style.display = 'none';
      document.getElementById('main-app').style.display = 'block';
      document.querySelector('.container').style.justifyContent = 'flex-start';
      
      if(json.settings) {
          if(json.settings.schoolName) {
             document.querySelector('#login-box .school-header').innerText = json.settings.schoolName;
             document.getElementById('school-header-main').innerText = json.settings.schoolName;
          }
          if(json.settings.eventName) document.getElementById('event-header').innerText = json.settings.eventName;
      }

      localData = json.data; 
      renderSmart(); // ä½¿ç”¨æ™ºæ…§æ¸²æŸ“
      var now = new Date(); document.getElementById('last-update').innerText = "æœ€å¾Œæ›´æ–°: " + now.toLocaleTimeString();
      startTimer();
    })
    .catch(err => { console.error(err); alert("é€£ç·šéŒ¯èª¤"); btn.innerText = "é€²å…¥ç³»çµ±"; btn.disabled = false; });
  }

  function startTimer() { if(timer) clearInterval(timer); timer = setInterval(fetchData, 20000); } // æ”¹ç‚º 20 ç§’æ›´æ–°ä¸€æ¬¡
  function manualUpdate() { fetchData(); startTimer(); }
  
  function fetchData() {
    var statusLabel = document.getElementById('last-update'); statusLabel.innerText = "æ›´æ–°ä¸­...";
    fetch(API_URL, { method: "POST", body: JSON.stringify({ action: "getHostList", password: PASSWORD }) })
    .then(res => res.json()).then(json => {
      if(json.status === "error") { return; } 
      localData = json.data; 
      renderSmart(); // ä½¿ç”¨æ™ºæ…§æ¸²æŸ“
      var now = new Date(); statusLabel.innerText = "æœ€å¾Œæ›´æ–°: " + now.toLocaleTimeString();
    });
  }
  
  // ğŸ”¥ æ ¸å¿ƒï¼šæ™ºæ…§æ¯”å°æ¸²æŸ“ (Smart Diffing Render) ğŸ”¥
  function renderSmart() {
    var list = document.getElementById('list'); 
    var keyword = document.getElementById('host-search').value.toLowerCase().trim();

    // 1. å…ˆè¤‡è£½ä¸€ä»½è³‡æ–™ä¾†æ’åºéæ¿¾
    var displayData = [...localData];

    // 2. æœå°‹éæ¿¾
    if (keyword) {
        displayData = displayData.filter(d => 
            d.name.toLowerCase().includes(keyword) || d.title.toLowerCase().includes(keyword)
        );
    }

    // 3. æ’åº (å¾…ä»‹ç´¹ > æ¬Šé‡ > æ™‚é–“)
    displayData.sort((a, b) => {
      if (a.status !== b.status) return a.status === "å¾…ä»‹ç´¹" ? -1 : 1;
      var pA = a.priority || 0; var pB = b.priority || 0;
      if (pA !== pB) return pB - pA; 
      var tA = a.checkInTime || "99:99:99"; var tB = b.checkInTime || "99:99:99";
      if (tA < tB) return -1; if (tA > tB) return 1;
      return 0; 
    });

    if(displayData.length === 0) { 
        list.innerHTML = "<div class='text-center p-4 text-muted'>ç„¡ç¬¦åˆè³‡æ–™</div>"; 
        return; 
    }

    // 4. æ™ºæ…§ DOM æ›´æ–° (ä¸æ¸…é™¤ innerHTMLï¼Œè€Œæ˜¯ç§»å‹•æˆ–æ›´æ–°å…ƒç´ )
    // æ¨™è¨˜ç›®å‰åœ¨ç•«é¢ä¸Šçš„å¡ç‰‡ ID
    var existingIds = new Set();
    
    displayData.forEach(item => {
        var id = `card-${item.rowIndex}`;
        existingIds.add(id);
        var el = document.getElementById(id);
        
        var isDone = item.status === "å·²ä»‹ç´¹";
        var pLevel = item.priority || 0;
        var timeDisplay = item.checkInTime ? item.checkInTime.substring(0, 5) : "";
        var btnHtml = !isDone 
            ? `<div class="btn-pin s-level-${pLevel}" onclick="cyclePriority(${item.rowIndex})">â˜…</div><button class="btn-ok" onclick="markDone(${item.rowIndex})">ä»‹ç´¹</button>` 
            : `<button class="btn-undo" onclick="undo(${item.rowIndex})">â†©ï¸ å›å¾©</button>`;

        if (!el) {
            // æ–°å¡ç‰‡ï¼šå»ºç«‹ä¸¦åŠ å…¥
            var div = document.createElement('div');
            div.id = id;
            div.className = `row-card level-${pLevel} ${isDone ? 'done' : ''}`;
            div.innerHTML = `
              <div class="time">${timeDisplay}</div>
              <div class="info"><span class="job">${item.title}</span><span class="name">${item.name}</span></div>
              <div class="d-flex align-items-center">${btnHtml}</div>`;
            list.appendChild(div); // æš«æ™‚åŠ åˆ°æœ€å¾Œï¼Œç­‰ç­‰æœƒæ’åº
        } else {
            // èˆŠå¡ç‰‡ï¼šæ›´æ–°å…§å®¹ (åªå‹•æœ‰è®Šçš„)
            // æ›´æ–° Class (é¡è‰²)
            el.className = `row-card level-${pLevel} ${isDone ? 'done' : ''}`;
            // æ›´æ–°æŒ‰éˆ•å€ (é¿å…ä¸€ç›´é‡ç¹ªå°è‡´é–ƒçˆï¼Œé€™è£¡ç°¡å–®æš´åŠ›é‡å¯« innerHTMLï¼Œå› ç‚ºæŒ‰éˆ•ç‹€æ…‹å–®ç´”)
            // ç‚ºäº†æ¥µè‡´é˜²é–ƒçˆï¼Œå¯ä»¥æ¯”å° innerHTMLï¼Œä¸åŒæ‰å¯«å…¥
            var contentHtml = `
              <div class="time">${timeDisplay}</div>
              <div class="info"><span class="job">${item.title}</span><span class="name">${item.name}</span></div>
              <div class="d-flex align-items-center">${btnHtml}</div>`;
            if (el.innerHTML !== contentHtml) {
                el.innerHTML = contentHtml;
            }
        }
        
        // æ’åºé—œéµï¼šæŠŠé€™å€‹å…ƒç´  append åˆ° list çš„æœ€å¾Œé¢
        // å› ç‚ºæˆ‘å€‘æ˜¯ä¾ç…§æ­£ç¢ºé †åº loop çš„ï¼Œæ‰€ä»¥ appendChild æœƒæŠŠå®ƒã€Œç§»å‹•ã€åˆ°æ­£ç¢ºçš„é †åºä½ç½®
        list.appendChild(document.getElementById(id));
    });

    // 5. ç§»é™¤ä¸åœ¨æ–°åå–®ä¸­çš„èˆŠå¡ç‰‡
    Array.from(list.children).forEach(child => {
        if (child.id && !existingIds.has(child.id)) {
            child.remove();
        }
    });
  }

  function cyclePriority(rowIndex) {
    var target = localData.find(d => d.rowIndex == rowIndex);
    if(target) {
      var currentP = target.priority || 0;
      var newP = (currentP === 4) ? 1 : (currentP + 1) % 4;
      target.priority = newP; 
      renderSmart(); // æœ¬åœ°å…ˆæ›´æ–°
      fetch(API_URL, { method: "POST", body: JSON.stringify({ action: "updateStatus", rowIndex: rowIndex, type: "PIN" }) });
      // é»æ“Šç•¶ä¸‹æš«åœè‡ªå‹•æ›´æ–° 2 ç§’ï¼Œé¿å…æ‰‹è¢«ç§»é–‹
      if(timer) clearInterval(timer);
      setTimeout(startTimer, 2000);
    }
  }

  function markDone(rowIndex) {
    var target = localData.find(d => d.rowIndex == rowIndex); 
    if(target) { target.status = "å·²ä»‹ç´¹"; target.priority = 0; }
    renderSmart();
    fetch(API_URL, { method: "POST", body: JSON.stringify({ action: "updateStatus", rowIndex: rowIndex, type: "DONE" }) });
  }

  function undo(rowIndex) {
    var target = localData.find(d => d.rowIndex == rowIndex); 
    if(target) { target.status = "å¾…ä»‹ç´¹"; }
    renderSmart();
    fetch(API_URL, { method: "POST", body: JSON.stringify({ action: "updateStatus", rowIndex: rowIndex, type: "UNDO" }) });
  }
</script>
</body>
</html>
