<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æ¥å¾…è™•å ±åˆ°</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    /* ... æ¨£å¼ä¿æŒä¸è®Šï¼Œç‚ºäº†ç¯€çœç©ºé–“æˆ‘é€™è£¡çœç•¥ CSSï¼Œè«‹æ²¿ç”¨ä¸Šä¸€ç‰ˆçš„æ¨£å¼ ... */
    * { box-sizing: border-box; } 
    body { background: #f4f4f4; padding: 20px; font-family: "Microsoft JhengHei", sans-serif; min-height: 100vh; display: flex; flex-direction: column; }
    .container { max-width: 800px; margin: 0 auto; flex: 1; display: flex; flex-direction: column; justify-content: flex-start; }
    #login-box { display: none; } 
    .school-header { font-size: 1.1rem; color: #6c757d; font-weight: 700; margin-bottom: 5px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .event-main-title { font-size: clamp(1.5rem, 5vw, 2.5rem); font-weight: 800; color: #212529; text-align: center; margin: 10px 0 20px 0; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .tools-container { background: white; padding: 20px; border-radius: 16px; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
    .search-row { display: flex; gap: 10px; margin-bottom: 15px; }
    .search-box { border-radius: 12px; padding: 12px; border: 2px solid #eee; font-size: 1.1rem; flex: 1; }
    .search-box:focus { border-color: #212529; outline: none; }
    .btn-refresh { padding: 0 20px; border-radius: 12px; background: #212529; color: white; border: none; font-weight: bold; white-space: nowrap;}
    .add-area { border-top: 1px dashed #ddd; padding-top: 15px; }
    .add-label { font-weight: bold; color: #666; margin-bottom: 8px; display: block; font-size: 0.9rem; }
    .form-select { border-radius: 12px; padding: 10px; border: 2px solid #eee; }
    .section-header { padding: 12px 20px; background: #e9ecef; font-weight: bold; color: #555; font-size: 1.1rem; display: flex; justify-content: space-between; align-items: center; border-left: 5px solid #666; margin-top: 20px; margin-bottom: 10px; border-radius: 0 8px 8px 0; cursor: pointer; transition: background 0.2s; }
    .section-header:hover { background: #dee2e6; }
    .section-header.pending-zone { border-left-color: #dc3545; color: #dc3545; background: #fff5f5; }
    .collapse-icon { transition: transform 0.3s; }
    .collapsed .collapse-icon { transform: rotate(-90deg); }
    .dash-group-title { font-size: 1rem; color: #333; margin: 10px 5px 5px 5px; font-weight: 900; border-bottom: 2px solid #eee; padding-bottom: 5px;}
    .row-card { border-radius: 12px; padding: 15px 20px; margin-bottom: 10px; display: flex; align-items: center; justify-content: space-between; border: none !important; box-shadow: 0 0 0 1px #e0e0e0, 0 2px 4px rgba(0,0,0,0.05); background: white; min-height: 80px; transition: all 0.3s ease; }
    .row-card.arrived { background: #f8f9fa; opacity: 0.6; box-shadow: none; }
    .row-card.arrived .name { text-decoration: line-through; color: #999; }
    .info { flex: 1; padding-right: 15px; }
    .job { font-size: 14px; color: #666; display: block; }
    .name { font-size: 20px; font-weight: 800; color: #000; }
    .btn-checkin { background: #dc3545; color: white; border: none; padding: 10px 25px; border-radius: 50px; font-weight: bold; min-width: 80px; transition: background 0.2s; }
    .btn-checkin:disabled { background: #999; cursor: not-allowed; }
    .btn-add { background: #212529; color: white; font-weight: bold; border-radius: 8px; }
    @media (max-width: 576px) { .event-main-title { font-size: 1.6rem !important; margin: 15px 0; } .row-card { padding: 15px; min-height: 90px; } .name { font-size: 20px; } }
  </style>
</head>
<body>

<div class="container" id="login-section">
  <div id="login-box">
    <div class="school-header">è¼‰å…¥ä¸­...</div>
    <div class="login-title">æ¥å¾…è™•ç™»å…¥</div>
    <input type="password" id="pwd" class="form-control input-custom" placeholder="è«‹è¼¸å…¥æ¥å¾…å¯†ç¢¼">
    <button onclick="manualLogin()" class="btn btn-login">é€²å…¥ç³»çµ±</button>
  </div>
</div>

<div class="container" id="main-app">
  <div class="school-header" id="school-header-main" style="text-align: center; margin-top:20px;"></div>
  <h1 id="event-header" class="event-main-title">è¼‰å…¥ä¸­...</h1>

  <div class="tools-container">
    <div class="search-row">
        <input type="text" id="search" class="form-control search-box" placeholder="ğŸ” æœå°‹å§“åæˆ–è·ç¨±..." onkeyup="filterList()">
        <button onclick="manualUpdate()" class="btn-refresh">ğŸ”„ ç«‹å³æ›´æ–°</button>
    </div>
    
    <div class="add-area">
      <span class="add-label">â• ç¾å ´è£œç™» (åå–®å¤–è²´è³“)</span>
      <div class="row g-2">
        <div class="col-3">
            <select id="new-level" class="form-select">
                <option value="0">ä¾†è³“</option> 
            </select>
        </div>
        <div class="col-3"><input type="text" id="new-job" class="form-control" placeholder="è·ç¨±"></div>
        <div class="col-4"><input type="text" id="new-name" class="form-control" placeholder="å§“å"></div>
        <div class="col-2"><button onclick="addNew()" class="btn btn-add w-100">æ–°å¢</button></div>
      </div>
    </div>
  </div>

  <div id="guest-list">
      <div id="header-pending" class="section-header pending-zone" onclick="toggleCollapse('pending')">
          <span>ğŸ›‘ å¾…å ±åˆ° <span id="count-pending" class="badge bg-secondary ms-2">0</span></span>
          <span class="collapse-icon">â–¼</span>
      </div>
      <div id="container-pending" class="collapse show"></div>

      <div id="header-active" class="section-header" onclick="toggleCollapse('active')">
          <span>ğŸ“£ å·²åˆ°ç¾å ´ <span id="count-active" class="badge bg-secondary ms-2">0</span></span>
          <span class="collapse-icon">â–¼</span>
      </div>
      <div id="container-active" class="collapse"></div>

      <div id="header-done" class="section-header" onclick="toggleCollapse('done')">
          <span>âš« å·²å®Œæˆ <span id="count-done" class="badge bg-secondary ms-2">0</span></span>
          <span class="collapse-icon">â–¼</span>
      </div>
      <div id="container-done" class="collapse"></div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
  const API_URL = "https://script.google.com/macros/s/AKfycbw62YC7Q03CC-YL_UyBKR4JXfP_cU3OIiswA9LlHhKLIS1LJrCg2DBT441eaE880C05BA/exec";
  
  var PASSWORD = ""; var allGuests = []; var levelNames = {};
  var timer = null; 
  var isProcessing = false; 
  // å¢åŠ æ›´æ–°é »ç‡ç‚º 8 ç§’ï¼Œæ¸›å°‘å¹²æ“¾
  var REFRESH_RATE = 8000;

  window.onload = function() {
    var cached = localStorage.getItem('siteSettings');
    if(cached) {
        var data = JSON.parse(cached);
        document.getElementById('school-header-main').innerText = data.schoolName || "";
        document.getElementById('event-header').innerText = data.eventName || "";
    }

    var storedPwd = sessionStorage.getItem('reception_password');
    if (storedPwd) { 
        PASSWORD = storedPwd;
        manualLogin(); 
    } else {
        alert("è«‹å…ˆå¾é¦–é ç™»å…¥");
        window.location.href = "index.html";
    }
  };

  function toggleCollapse(type) {
      var el = document.getElementById('container-' + type);
      var header = document.getElementById('header-' + type);
      if(el.classList.contains('show')) {
          el.classList.remove('show');
          header.classList.add('collapsed');
      } else {
          el.classList.add('show');
          header.classList.remove('collapsed');
      }
  }

  function manualLogin() {
    fetch(API_URL, { method: "POST", body: JSON.stringify({ action: "getReceptionList", password: PASSWORD }) })
    .then(res => res.json()).then(json => {
      if(json.status === "error") { 
        alert("ç™»å…¥å¤±æ•—ï¼š" + json.message); 
        window.location.href = "index.html";
        return; 
      }
      
      document.getElementById('login-section').style.display = 'none';
      document.getElementById('main-app').style.display = 'block';
      
      if(json.settings) {
          if(json.settings.schoolName) document.getElementById('school-header-main').innerText = json.settings.schoolName;
          if(json.settings.eventName) document.getElementById('event-header').innerText = json.settings.eventName;
          
          localStorage.setItem('siteSettings', JSON.stringify({
              schoolName: json.settings.schoolName,
              eventName: json.settings.eventName
          }));

          if(json.settings.levelNames) {
              levelNames = json.settings.levelNames;
              var select = document.getElementById('new-level');
              select.innerHTML = "";
              [3, 2, 1, 0].forEach(l => {
                  var name = levelNames[l] || "ç­‰ç´š"+l;
                  var opt = document.createElement('option');
                  opt.value = l;
                  opt.innerText = name;
                  select.appendChild(opt);
              });
              select.value = 0; 
          }
      }
      
      allGuests = json.data; 
      renderLists();
      startTimer(); 
    })
    .catch(err => { console.error(err); alert("é€£ç·šéŒ¯èª¤ï¼Œè«‹é‡æ–°æ•´ç†"); });
  }

  function startTimer() { if(timer) clearInterval(timer); timer = setInterval(fetchData, REFRESH_RATE); }
  function manualUpdate() { fetchData(); startTimer(); }

  function fetchData() {
      if(isProcessing) return; 
      
      var btn = document.querySelector('.btn-refresh');
      if(btn) { var orgText = btn.innerText; btn.innerText = "..."; btn.disabled = true; }
      
      fetch(API_URL, { method: "POST", body: JSON.stringify({ action: "getReceptionList", password: PASSWORD }) })
      .then(res => res.json()).then(json => {
          if(btn) { btn.innerText = "ğŸ”„ ç«‹å³æ›´æ–°"; btn.disabled = false; }
          if(isProcessing) return;

          if(json.status === "success") {
              allGuests = json.data;
              renderLists();
          }
      });
  }

  // ğŸ”¥ Smart DOM Update: é€™æ˜¯è§£æ±ºæŒ‰éˆ•å¤±æ•ˆçš„æ ¸å¿ƒ
  function renderLists() {
    var keyword = document.getElementById('search').value.toLowerCase().trim();
    var receptionData = allGuests.filter(d => d.source !== "GUEST");

    if(keyword) {
        receptionData = receptionData.filter(d => d.name.toLowerCase().includes(keyword) || d.title.toLowerCase().includes(keyword));
    }

    // åˆ†é¡
    var pendingList = receptionData.filter(d => d.status === "æœªå ±åˆ°");
    var activeList = receptionData.filter(d => d.status === "å¾…ä»‹ç´¹");
    var doneList = receptionData.filter(d => d.status === "å·²ä»‹ç´¹");

    // æ›´æ–°è¨ˆæ•¸
    document.getElementById('count-pending').innerText = pendingList.length;
    document.getElementById('count-active').innerText = activeList.length;
    document.getElementById('count-done').innerText = doneList.length;

    // åˆ†åˆ¥æ›´æ–°ä¸‰å€‹å€å¡Šï¼Œä½¿ç”¨ DOM Reuse
    updateContainer('container-pending', pendingList, 'pending');
    updateContainer('container-active', activeList, 'active');
    updateContainer('container-done', doneList, 'done');
  }

  function updateContainer(containerId, data, type) {
      var container = document.getElementById(containerId);
      
      // 1. æ’åº
      data.sort((a, b) => {
          var lvlA = a.originLevel || 0; var lvlB = b.originLevel || 0;
          if (lvlA !== lvlB) return lvlB - lvlA;
          if(type === 'pending') return a.rowIndex - b.rowIndex; 
          var tA = a.checkInTime || "99:99:99"; var tB = b.checkInTime || "99:99:99";
          if (tA < tB) return -1; if (tA > tB) return 1; return 0;
      });

      // 2. æ¨™è¨˜ç¾æœ‰çš„ IDs
      var existingIds = new Set();
      
      // 3. åˆ†çµ„æ¸²æŸ“ (ç”¢ç”Ÿæ¨™é¡Œ)
      // é€™è£¡ç‚ºäº†ç°¡åŒ– DOM diffingï¼Œæˆ‘å€‘é‚„æ˜¯å¾—æ¸…ç©ºå®¹å™¨ï¼Œ
      // ä½†ç‚ºäº†ä¿ç•™æŒ‰éˆ•ç‹€æ…‹ï¼Œæˆ‘å€‘å¯ä»¥è©¦è‘—åªæ›´æ–°å¡ç‰‡ã€‚
      // **æŠ˜è¡·æ–¹æ¡ˆ**ï¼šæ—¢ç„¶æˆ‘å€‘æœ‰ "isProcessing" é–å®šï¼Œç›´æ¥é‡ç¹ªæ˜¯æœ€å®‰å…¨çš„ï¼Œ
      // åªè¦åœ¨æŒ‰ä¸‹çš„ç¬é–“é–å®šæ›´æ–°å³å¯ã€‚
      // ä¸Šä¸€ç‰ˆçš„å•é¡Œæ˜¯æ²’æœ‰ç”¨ container åˆ†é–‹ï¼Œå°è‡´æ¯æ¬¡éƒ½é‡ç¹ªæ•´å€‹å¤§æ¸…å–®ã€‚
      // ç¾åœ¨åˆ†é–‹å¾Œï¼Œå¦‚æœæˆ‘åªæ“ä½œ "pending" å€ï¼Œå…¶ä»–å€é‡ç¹ªæ²’é—œä¿‚ã€‚
      
      var html = "";
      if(data.length === 0) {
          container.innerHTML = `<div class="text-center p-3 text-muted">ç„¡è³‡æ–™</div>`;
          return;
      }

      [3, 2, 1, 0].forEach(lvl => {
          var items = data.filter(d => (d.originLevel || 0) === lvl);
          if (items.length > 0) {
              var groupName = (levelNames && levelNames[lvl]) ? levelNames[lvl] : "è²´è³“";
              html += `<div class="dash-group-title">${groupName}</div>`;
              items.forEach(item => {
                  var btnHtml = "";
                  var rowClass = "row-card";
                  
                  if(type === "pending") {
                      btnHtml = `<button class="btn-checkin" id="btn-${item.rowIndex}" onclick="toggleStatus(${item.rowIndex}, 'CHECKIN')">å¾…å ±åˆ°</button>`;
                  } else if(type === "active") {
                      btnHtml = `<span class="text-success fw-bold">å¾…ä»‹ç´¹</span>`;
                  } else {
                      rowClass += " arrived";
                      btnHtml = `<span class="text-muted">å·²å®Œæˆ</span>`;
                  }

                  html += `<div class="${rowClass}" id="card-${item.rowIndex}">
                      <div class="info"><span class="job">${item.title}</span><span class="name">${item.name}</span></div>
                      <div>${btnHtml}</div>
                    </div>`;
              });
          }
      });
      
      // åªæœ‰ç•¶ HTML çœŸçš„è®Šäº†æ‰å¯«å…¥ï¼Œé˜²æ­¢å¾®å°é–ƒçˆ
      if (container.innerHTML !== html) {
          container.innerHTML = html;
      }
  }

  function filterList() { renderLists(); }

  // ğŸ”¥ é˜²é–ƒçˆæ ¸å¿ƒ + æŒ‰éˆ•ç«‹å³åæ‡‰
  function toggleStatus(rowIndex, type) {
    if(isProcessing) return; // é–å®š
    
    // 1. ç«‹å³é–å®šè‡ªå‹•æ›´æ–°
    if(timer) clearInterval(timer);
    isProcessing = true;

    // 2. è®“æŒ‰éˆ•è®Šç°ï¼Œé¡¯ç¤º "..." (UI åæ‡‰)
    var btn = document.getElementById('btn-' + rowIndex);
    if(btn) { btn.innerText = "..."; btn.disabled = true; }

    // 3. æœ¬åœ°é åˆ¤æ›´æ–° (Optimistic UI)
    var target = allGuests.find(g => g.rowIndex == rowIndex);
    if (target) {
        if (type === "CHECKIN") { 
            target.status = "å¾…ä»‹ç´¹"; 
            var now = new Date(); target.checkInTime = now.toTimeString().split(' ')[0]; 
        } 
    }
    
    // 4. é‡ç¹ª (é€™æ™‚å€™å¡ç‰‡æœƒé£›åˆ°ä¸‹ä¸€å€)
    renderLists();

    // 5. ç™¼é€è«‹æ±‚ -> å»¶é²è§£é–
    fetch(API_URL, { method: "POST", body: JSON.stringify({ action: "receptionAction", rowIndex: rowIndex, type: type }) })
    .then(() => {
        setTimeout(() => {
            isProcessing = false; // è§£é–
            fetchData(); // é‡æ–°æ‹‰å–
            startTimer(); // é‡å•Ÿ Timer
        }, 2500);
    })
    .catch(() => { isProcessing = false; startTimer(); });
  }

  function addNew() {
    var title = document.getElementById('new-job').value;
    var name = document.getElementById('new-name').value;
    var level = document.getElementById('new-level').value;
    if(!name) { alert("è«‹è¼¸å…¥å§“å"); return; }
    
    if(confirm(`ç¢ºèªæ–°å¢ä¸¦å ±åˆ°ï¼š\n${title} ${name} ï¼Ÿ`)) {
        var btn = document.querySelector('.btn-add'); var orgText = btn.innerText; btn.innerText = "..."; btn.disabled = true;
        
        fetch(API_URL, { method: "POST", body: JSON.stringify({ action: "guestCheckIn", title: title, name: name, level: level, isReception: true }) })
        .then(() => {
            alert("æ–°å¢æˆåŠŸï¼");
            document.getElementById('new-job').value=""; document.getElementById('new-name').value=""; 
            fetchData(); 
            btn.innerText = orgText; btn.disabled = false;
        });
    }
  }
</script>
</body>
</html>
