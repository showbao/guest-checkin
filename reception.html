<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æ¥å¾…è™•å ±åˆ°</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    /* === å…¨åŸŸè¨­å®š (èˆ‡ä¸»æŒäººç«¯ä¸€è‡´) === */
    * { box-sizing: border-box; } 
    body { background: #f4f4f4; padding: 20px; font-family: "Microsoft JhengHei", sans-serif; min-height: 100vh; display: flex; flex-direction: column; }
    .container { max-width: 800px; margin: 0 auto; flex: 1; display: flex; flex-direction: column; justify-content: flex-start; }

    /* === ç™»å…¥å¡ç‰‡ === */
    #login-box { background: white; padding: 40px 30px; border-radius: 24px; box-shadow: 0 10px 30px rgba(0,0,0,0.06); max-width: 450px; width: 100%; margin: 50px auto; text-align: center; }
    .school-header { font-size: 1.1rem; color: #6c757d; font-weight: 700; margin-bottom: 5px; letter-spacing: 1px; text-align: center; }
    .login-title { font-size: 1.5rem; font-weight: 800; color: #333; margin-bottom: 30px; }
    .input-custom { background-color: #f0f2f5; border: none; border-radius: 12px; padding: 15px; font-size: 1rem; text-align: center; }
    .btn-login { background: #000; color: white; border-radius: 12px; padding: 12px; font-weight: bold; font-size: 1.1rem; width: 100%; margin-top: 20px; }

    /* === ä¸»ç•«é¢ === */
    #main-app { display: none; width: 100%; }
    .event-main-title { font-size: 2.5rem; font-weight: 800; color: #212529; text-align: center; margin: 10px 0 20px 0; line-height: 1.2; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

    /* === å·¥å…·å€ (æœå°‹ & è£œç™») === */
    .tools-container { background: white; padding: 20px; border-radius: 16px; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
    .search-box { border-radius: 12px; padding: 12px; border: 2px solid #eee; width: 100%; margin-bottom: 15px; font-size: 1.1rem; }
    .search-box:focus { border-color: #212529; outline: none; }
    
    .add-area { border-top: 1px dashed #ddd; padding-top: 15px; }
    .add-label { font-weight: bold; color: #666; margin-bottom: 8px; display: block; font-size: 0.9rem; }

    /* === å¡ç‰‡æ¨£å¼ (å¹½éˆé‚Šæ¡†) === */
    .row-card { 
        border-radius: 12px; padding: 20px 25px; margin-bottom: 12px; display: flex; align-items: center; justify-content: space-between; 
        border: none !important; box-shadow: 0 0 0 1px #e0e0e0, 0 2px 4px rgba(0,0,0,0.05); 
        background: white; min-height: 100px; transition: all 0.3s ease; 
    }
    
    /* å·²å ±åˆ°æ¨£å¼ (ä¸‹æ²‰ã€è®Šæ·¡) */
    .row-card.arrived { background: #f8f9fa; opacity: 0.7; box-shadow: none; border: 1px solid #eee !important; }
    .row-card.arrived .name, .row-card.arrived .job { text-decoration: line-through; color: #999; }

    .info { flex: 1; padding-right: 15px; }
    .job { font-size: 15px; color: #666; display: block; margin-bottom: 2px; }
    .name { font-size: 24px; font-weight: 800; color: #000; display: block; line-height: 1.2; }

    /* æŒ‰éˆ• */
    .btn-checkin { background: #0d6efd; color: white; border: none; padding: 10px 25px; border-radius: 50px; font-weight: bold; font-size: 16px; cursor: pointer; min-width: 80px; }
    .btn-undo { background: #ffc107; color: #333; border: none; padding: 10px 20px; border-radius: 50px; font-size: 14px; cursor: pointer; min-width: 80px; }
    .btn-add { background: #212529; color: white; font-weight: bold; border-radius: 8px; }

    /* æ‰‹æ©Ÿç‰ˆå„ªåŒ– */
    @media (max-width: 576px) {
        .event-main-title { font-size: 1.6rem !important; margin: 15px 0; }
        .row-card { padding: 15px; min-height: 90px; }
        .name { font-size: 20px; }
    }
  </style>
</head>
<body>

<div class="container" id="login-section">
  <div id="login-box">
    <div class="school-header">åŒ—å±¯å€å»ºåŠŸåœ‹å°</div>
    <div style="font-size: 3rem; margin-bottom: 10px;">ğŸ”’</div>
    <div class="login-title">æ¥å¾…è™•ç™»å…¥</div>
    <input type="password" id="pwd" class="form-control input-custom" placeholder="è«‹è¼¸å…¥æ¥å¾…å¯†ç¢¼">
    <button onclick="manualLogin()" class="btn btn-login">é€²å…¥ç³»çµ±</button>
  </div>
</div>

<div class="container" id="main-app">
  <div class="school-header" style="margin-top: 20px;">åŒ—å±¯å€å»ºåŠŸåœ‹å°</div>
  <h1 id="event-header" class="event-main-title">è¼‰å…¥ä¸­...</h1>

  <div class="tools-container">
    <input type="text" id="search" class="form-control search-box" placeholder="ğŸ” æœå°‹å§“åæˆ–è·ç¨±..." onkeyup="filterList()">
    
    <div class="add-area">
      <span class="add-label">â• ç¾å ´è£œç™» (åå–®å¤–è²´è³“)</span>
      <div class="row g-2">
        <div class="col-4"><input type="text" id="new-job" class="form-control" placeholder="è·ç¨±"></div>
        <div class="col-5"><input type="text" id="new-name" class="form-control" placeholder="å§“å"></div>
        <div class="col-3"><button onclick="addNew()" class="btn btn-add w-100">æ–°å¢</button></div>
      </div>
    </div>
  </div>

  <div id="guest-list">
    <div class="text-center text-muted p-4">æº–å‚™è®€å–è³‡æ–™...</div>
  </div>
</div>

<script>
  // âš ï¸âš ï¸âš ï¸ è¨˜å¾—æ›æˆæœ€æ–°çš„ GAS ç¶²å€ âš ï¸âš ï¸âš ï¸
  const API_URL = "https://script.google.com/macros/s/AKfycbw62YC7Q03CC-YL_UyBKR4JXfP_cU3OIiswA9LlHhKLIS1LJrCg2DBT441eaE880C05BA/exec";
  
  var PASSWORD = "";
  var allGuests = [];

  // è‡ªå‹•ç™»å…¥æª¢æŸ¥
  window.onload = function() {
    var storedPwd = sessionStorage.getItem('reception_password');
    if (storedPwd) {
      document.getElementById('pwd').value = storedPwd;
      setTimeout(manualLogin, 100);
    }
  };

  function manualLogin() {
    PASSWORD = document.getElementById('pwd').value;
    document.querySelector('.btn-login').innerText = "é©—è­‰ä¸­...";
    document.querySelector('.btn-login').disabled = true;

    fetch(API_URL, { method: "POST", body: JSON.stringify({ action: "getReceptionList", password: PASSWORD }) })
    .then(res => res.json()).then(json => {
      if(json.status === "error") { 
        alert("ç™»å…¥å¤±æ•—ï¼š" + json.message);
        document.querySelector('.btn-login').innerText = "é€²å…¥ç³»çµ±";
        document.querySelector('.btn-login').disabled = false;
        sessionStorage.removeItem('reception_password');
        return; 
      }
      
      // åˆ‡æ›ç•«é¢
      document.getElementById('login-section').style.display = 'none';
      document.getElementById('main-app').style.display = 'block';
      
      // è¨­å®šæ¨™é¡Œ
      if(json.eventName) document.getElementById('event-header').innerText = json.eventName;
      
      allGuests = json.data; 
      renderList(allGuests);
    })
    .catch(err => { console.error(err); alert("é€£ç·šéŒ¯èª¤"); });
  }

  function renderList(data) {
    var list = document.getElementById('guest-list'); 
    list.innerHTML = "";
    
    // æ’åºé‚è¼¯ï¼šæœªå ±åˆ°(æ’ä¸Šé¢) > å¾…ä»‹ç´¹(å·²å ±åˆ°,æ’ä¸‹é¢) > å·²ä»‹ç´¹(è¦–åŒå·²å ±åˆ°)
    // æ³¨æ„ï¼šfilter å¿…é ˆä¿ç•™ "æœªå ±åˆ°" å’Œ "å¾…ä»‹ç´¹"
    var visibleData = data.filter(d => d.status === "æœªå ±åˆ°" || d.status === "å¾…ä»‹ç´¹");

    if(visibleData.length === 0) { 
        list.innerHTML = "<div class='text-center p-4 text-muted'>æ²’æœ‰ç¬¦åˆçš„åå–®</div>"; 
        return; 
    }

    // æ’åºï¼šæœªå ±åˆ°(-1) æ’åœ¨ å¾…ä»‹ç´¹(1) å‰é¢
    visibleData.sort((a, b) => {
        var scoreA = (a.status === "æœªå ±åˆ°") ? -1 : 1;
        var scoreB = (b.status === "æœªå ±åˆ°") ? -1 : 1;
        if(scoreA !== scoreB) return scoreA - scoreB;
        return a.rowIndex - b.rowIndex; // åŒç‹€æ…‹ä¾åŸå§‹é †åº
    });

    visibleData.forEach(item => {
      var isArrived = (item.status === "å¾…ä»‹ç´¹"); // å·²å ±åˆ°
      var rowClass = isArrived ? "row-card arrived" : "row-card";
      var btnHtml = isArrived 
        ? `<button class="btn-undo" onclick="toggleStatus(${item.rowIndex}, 'UNDO')">â†©ï¸ å›å¾©</button>`
        : `<button class="btn-checkin" onclick="toggleStatus(${item.rowIndex}, 'CHECKIN')">å ±åˆ°</button>`;

      var html = `
        <div class="${rowClass}" id="card-${item.rowIndex}">
          <div class="info">
            <span class="job">${item.title}</span>
            <span class="name">${item.name}</span>
          </div>
          <div>${btnHtml}</div>
        </div>`;
      list.innerHTML += html;
    });
  }

  function filterList() {
    var keyword = document.getElementById('search').value.toLowerCase().trim();
    if(!keyword) { renderList(allGuests); return; }
    
    var filtered = allGuests.filter(d => 
      (d.name.toLowerCase().includes(keyword) || d.title.toLowerCase().includes(keyword)) && 
      (d.status === "æœªå ±åˆ°" || d.status === "å¾…ä»‹ç´¹")
    );
    renderList(filtered); // ä½¿ç”¨ç›¸åŒçš„æ¸²æŸ“é‚è¼¯ï¼Œä¿æŒæ’åºå’Œæ¨£å¼
  }

  // çµ±ä¸€è™•ç† å ±åˆ° èˆ‡ å›å¾©
  function toggleStatus(rowIndex, type) {
    // 1. å…ˆæ›´æ–°æœ¬åœ°è³‡æ–™ (è®“ UI ç¬é–“åæ‡‰)
    var target = allGuests.find(g => g.rowIndex == rowIndex);
    if (target) {
        target.status = (type === "CHECKIN") ? "å¾…ä»‹ç´¹" : "æœªå ±åˆ°";
    }
    
    // 2. é‡æ–°æ¸²æŸ“ (æœƒè‡ªå‹•æ’åº)
    // å¦‚æœæ­£åœ¨æœå°‹ï¼Œä¿æŒæœå°‹çµæœï¼›å¦å‰‡é¡¯ç¤ºå…¨éƒ¨
    var keyword = document.getElementById('search').value.trim();
    if(keyword) filterList(); else renderList(allGuests);

    // 3. èƒŒæ™¯ç™¼é€ API
    fetch(API_URL, { 
        method: "POST", 
        body: JSON.stringify({ action: "receptionAction", rowIndex: rowIndex, type: type }) 
    });
  }

  function addNew() {
    var title = document.getElementById('new-job').value;
    var name = document.getElementById('new-name').value;
    if(!name) { alert("è«‹è¼¸å…¥å§“å"); return; }
    
    if(confirm(`ç¢ºèªæ–°å¢ä¸¦å ±åˆ°ï¼š\n${title} ${name} ï¼Ÿ`)) {
        // é–å®šæŒ‰éˆ•
        var btn = document.querySelector('.btn-add');
        var orgText = btn.innerText;
        btn.innerText = "..."; btn.disabled = true;

        fetch(API_URL, { method: "POST", body: JSON.stringify({ action: "guestCheckIn", title: title, name: name }) })
        .then(() => {
            alert("æ–°å¢æˆåŠŸï¼");
            document.getElementById('new-job').value=""; 
            document.getElementById('new-name').value=""; 
            // é‡æ–°è®€å–å®Œæ•´åå–®
            manualLogin(); 
            btn.innerText = orgText; btn.disabled = false;
        });
    }
  }
</script>
</body>
</html>
