<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æ¥å¾…è™•å ±åˆ°</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    * { box-sizing: border-box; } 
    body { background: #f4f4f4; padding: 20px; font-family: "Microsoft JhengHei", sans-serif; min-height: 100vh; display: flex; flex-direction: column; }
    .container { max-width: 800px; margin: 0 auto; flex: 1; display: flex; flex-direction: column; justify-content: flex-start; }

    #login-box { display: none; } /* é è¨­éš±è—ï¼Œç”±ç¨‹å¼æ§åˆ¶ */
    
    .school-header { font-size: 1.1rem; color: #6c757d; font-weight: 700; margin-bottom: 5px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .event-main-title { font-size: clamp(1.5rem, 5vw, 2.5rem); font-weight: 800; color: #212529; text-align: center; margin: 10px 0 20px 0; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

    .tools-container { background: white; padding: 20px; border-radius: 16px; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
    .search-row { display: flex; gap: 10px; margin-bottom: 15px; }
    .search-box { border-radius: 12px; padding: 12px; border: 2px solid #eee; font-size: 1.1rem; flex: 1; }
    .btn-refresh { padding: 0 20px; border-radius: 12px; background: #212529; color: white; border: none; font-weight: bold; white-space: nowrap;}
    
    .add-area { border-top: 1px dashed #ddd; padding-top: 15px; }
    .add-label { font-weight: bold; color: #666; margin-bottom: 8px; display: block; font-size: 0.9rem; }
    .form-select { border-radius: 12px; padding: 10px; border: 2px solid #eee; }

    .section-header { 
        padding: 12px 20px; background: #e9ecef; font-weight: bold; color: #555; font-size: 1.1rem;
        display: flex; justify-content: space-between; align-items: center;
        border-left: 5px solid #666; margin-top: 20px; margin-bottom: 10px; border-radius: 0 8px 8px 0;
        cursor: pointer; transition: background 0.2s;
    }
    .section-header:hover { background: #dee2e6; }
    .section-header.pending-zone { border-left-color: #dc3545; color: #dc3545; background: #fff5f5; }
    
    .collapse-icon { transition: transform 0.3s; }
    .collapsed .collapse-icon { transform: rotate(-90deg); }

    .dash-group-title { font-size: 1rem; color: #333; margin: 10px 5px 5px 5px; font-weight: 900; border-bottom: 2px solid #eee; padding-bottom: 5px;}

    .row-card { 
        border-radius: 12px; padding: 15px 20px; margin-bottom: 10px; display: flex; align-items: center; justify-content: space-between; 
        border: none !important; box-shadow: 0 0 0 1px #e0e0e0, 0 2px 4px rgba(0,0,0,0.05); 
        background: white; min-height: 80px; transition: all 0.3s ease; 
    }
    .row-card.arrived { background: #f8f9fa; opacity: 0.6; box-shadow: none; }
    .row-card.arrived .name { text-decoration: line-through; color: #999; }

    .info { flex: 1; padding-right: 15px; }
    .job { font-size: 14px; color: #666; display: block; }
    .name { font-size: 20px; font-weight: 800; color: #000; }

    .btn-checkin { background: #dc3545; color: white; border: none; padding: 10px 25px; border-radius: 50px; font-weight: bold; min-width: 80px; transition: background 0.2s; }
    .btn-checkin:disabled { background: #999; cursor: not-allowed; }
    .btn-add { background: #212529; color: white; font-weight: bold; border-radius: 8px; }

    @media (max-width: 576px) {
        .event-main-title { font-size: 1.6rem !important; margin: 15px 0; }
        .row-card { padding: 15px; min-height: 90px; }
        .name { font-size: 20px; }
    }
  </style>
</head>
<body>

<div class="container" id="main-app">
  <div class="school-header" id="school-header-main" style="text-align: center; margin-top:20px;"></div>
  <h1 id="event-header" class="event-main-title">è¼‰å…¥ä¸­...</h1>

  <div class="tools-container">
    <div class="search-row">
        <input type="text" id="search" class="form-control search-box" placeholder="ğŸ” æœå°‹å§“åæˆ–è·ç¨±..." onkeyup="filterList()">
        <button onclick="manualUpdate()" class="btn-refresh">ğŸ”„ ç«‹å³æ›´æ–°</button>
    </div>
    
    <div class="add-area">
      <span class="add-label">â• ç¾å ´è£œç™» (åå–®å¤–è²´è³“)</span>
      <div class="row g-2">
        <div class="col-3">
            <select id="new-level" class="form-select">
                <option value="0">ä¾†è³“</option> </select>
        </div>
        <div class="col-3"><input type="text" id="new-job" class="form-control" placeholder="è·ç¨±"></div>
        <div class="col-4"><input type="text" id="new-name" class="form-control" placeholder="å§“å"></div>
        <div class="col-2"><button onclick="addNew()" class="btn btn-add w-100">æ–°å¢</button></div>
      </div>
    </div>
  </div>

  <div id="guest-list"></div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
  // âš ï¸âš ï¸âš ï¸ è¨˜å¾—ç¢ºèª GAS ç¶²å€ âš ï¸âš ï¸âš ï¸
  const API_URL = "https://script.google.com/macros/s/AKfycbw62YC7Q03CC-YL_UyBKR4JXfP_cU3OIiswA9LlHhKLIS1LJrCg2DBT441eaE880C05BA/exec";
  
  var PASSWORD = ""; var allGuests = []; var levelNames = {};
  var timer = null; 
  var isProcessing = false; 
  var sectionStates = { pending: true, active: false, done: false };

  // è‡ªå‹•ç™»å…¥
  window.onload = function() {
    var storedPwd = sessionStorage.getItem('reception_password');
    if (storedPwd) { 
        PASSWORD = storedPwd;
        manualLogin(); 
    } else {
        alert("è«‹å…ˆå¾é¦–é ç™»å…¥");
        window.location.href = "index.html";
    }
  };

  function manualLogin() {
    fetch(API_URL, { method: "POST", body: JSON.stringify({ action: "getReceptionList", password: PASSWORD }) })
    .then(res => res.json()).then(json => {
      if(json.status === "error") { 
        alert("ç™»å…¥å¤±æ•—ï¼š" + json.message); 
        window.location.href = "index.html";
        return; 
      }
      
      if(json.settings) {
          if(json.settings.schoolName) document.getElementById('school-header-main').innerText = json.settings.schoolName;
          if(json.settings.eventName) document.getElementById('event-header').innerText = json.settings.eventName;
          
          // æ›´æ–°ä¸‹æ‹‰é¸å–®
          if(json.settings.levelNames) {
              levelNames = json.settings.levelNames;
              var select = document.getElementById('new-level');
              select.innerHTML = "";
              // ä¾åºåŠ å…¥é¸é … 3, 2, 1, 0 (å°æ‡‰ ç«‹å§”, æ ¡é•·, å®¶å§”, è²´è³“)
              [3, 2, 1, 0].forEach(l => {
                  var name = levelNames[l] || "ç­‰ç´š"+l;
                  var opt = document.createElement('option');
                  opt.value = l;
                  opt.innerText = name;
                  select.appendChild(opt);
              });
              select.value = 0; // é è¨­ä¾†è³“
          }
      }
      
      allGuests = json.data; 
      renderLists();
      startTimer(); 
    })
    .catch(err => { console.error(err); alert("é€£ç·šéŒ¯èª¤ï¼Œè«‹é‡æ–°æ•´ç†"); });
  }

  function startTimer() { if(timer) clearInterval(timer); timer = setInterval(fetchData, 5000); }
  function manualUpdate() { fetchData(); startTimer(); }

  function fetchData() {
      if(isProcessing) return; 
      saveCollapseState();
      
      var btn = document.querySelector('.btn-refresh');
      if(btn) { var orgText = btn.innerText; btn.innerText = "..."; btn.disabled = true; }
      
      fetch(API_URL, { method: "POST", body: JSON.stringify({ action: "getReceptionList", password: PASSWORD }) })
      .then(res => res.json()).then(json => {
          if(btn) { btn.innerText = "ğŸ”„ ç«‹å³æ›´æ–°"; btn.disabled = false; }
          if(isProcessing) return;

          if(json.status === "success") {
              allGuests = json.data;
              renderLists();
          }
      });
  }

  function saveCollapseState() {
      var elPending = document.getElementById('collapse-pending');
      var elActive = document.getElementById('collapse-active');
      var elDone = document.getElementById('collapse-done');
      if(elPending) sectionStates.pending = elPending.classList.contains('show');
      if(elActive) sectionStates.active = elActive.classList.contains('show');
      if(elDone) sectionStates.done = elDone.classList.contains('show');
  }

  function renderLists() {
    var list = document.getElementById('guest-list'); 
    var keyword = document.getElementById('search').value.toLowerCase().trim();
    var receptionData = allGuests.filter(d => d.source !== "GUEST");

    if(keyword) {
        receptionData = receptionData.filter(d => d.name.toLowerCase().includes(keyword) || d.title.toLowerCase().includes(keyword));
    }

    var pendingList = receptionData.filter(d => d.status === "æœªå ±åˆ°");
    var activeList = receptionData.filter(d => d.status === "å¾…ä»‹ç´¹");
    var doneList = receptionData.filter(d => d.status === "å·²ä»‹ç´¹");

    var html = "";
    var showPending = sectionStates.pending ? "show" : "";
    var showActive = sectionStates.active ? "show" : "";
    var showDone = sectionStates.done ? "show" : "";

    html += createSectionHtml("pending", "ğŸ›‘ å¾…å ±åˆ° (å°šæœªåˆ°æ ¡)", pendingList, showPending, "pending-zone");
    html += createSectionHtml("active", "ğŸ“£ å·²åˆ°ç¾å ´ (å¾…ä»‹ç´¹)", activeList, showActive, "");
    html += createSectionHtml("done", "âš« å·²å®Œæˆ (å·²ä»‹ç´¹)", doneList, showDone, "");

    // ğŸ”¥ Smart Diffing é‚è¼¯ï¼šå¦‚æœå®¹å™¨ä¸å­˜åœ¨ï¼Œç›´æ¥å¯«å…¥ï¼›å¦‚æœå­˜åœ¨ï¼Œå‰‡ç›¡é‡ä¸ç ´å£ DOM
    // ç‚ºäº†ç°¡å–®èµ·è¦‹ï¼Œé€™è£¡é‚„æ˜¯ä½¿ç”¨ innerHTMLï¼Œä½†å› ç‚ºæˆ‘å€‘å·²ç¶“æœ‰ã€ŒæŒ‰éˆ•é»æ“Šå¾Œç«‹å³é–å®šã€çš„é‚è¼¯ï¼Œæ‰€ä»¥å¯ä»¥è§£æ±ºæŒ‰ä¸åˆ°çš„å•é¡Œã€‚
    // é€²éšåšæ³•æ˜¯æ¯”è¼ƒ HTML å­—ä¸²ï¼Œé€™è£¡å…ˆç¶­æŒç°¡å–®ã€‚
    list.innerHTML = html;
  }

  function createSectionHtml(type, title, data, showClass, headerClass) {
      var collapsedState = showClass ? "" : "collapsed";
      var count = data.length;
      
      var html = `
        <div class="section-header ${headerClass} ${collapsedState}" data-bs-toggle="collapse" data-bs-target="#collapse-${type}" onclick="saveCollapseState()">
            <span>${title} <span class="badge bg-secondary ms-2">${count}</span></span>
            <span class="collapse-icon">â–¼</span>
        </div>
        <div id="collapse-${type}" class="collapse ${showClass}">
      `;

      if(data.length === 0) {
          html += `<div class="text-center p-3 text-muted">ç„¡è³‡æ–™</div>`;
      } else {
          data.sort((a, b) => {
              var lvlA = a.originLevel || 0; var lvlB = b.originLevel || 0;
              if (lvlA !== lvlB) return lvlB - lvlA;
              if(type === 'pending') return a.rowIndex - b.rowIndex; 
              var tA = a.checkInTime || "99:99:99"; var tB = b.checkInTime || "99:99:99";
              if (tA < tB) return -1; if (tA > tB) return 1; return 0;
          });

          [3, 2, 1, 0].forEach(lvl => {
              var items = data.filter(d => (d.originLevel || 0) === lvl);
              if (items.length > 0) {
                  var groupName = (levelNames && levelNames[lvl]) ? levelNames[lvl] : "è²´è³“";
                  html += `<div class="dash-group-title">${groupName}</div>`;
                  items.forEach(item => {
                      var btnHtml = "";
                      var rowClass = "row-card";
                      
                      if(type === "pending") {
                          // æŒ‰éˆ•ï¼šå¾…å ±åˆ°
                          btnHtml = `<button class="btn-checkin" id="btn-${item.rowIndex}" onclick="toggleStatus(${item.rowIndex}, 'CHECKIN')">å¾…å ±åˆ°</button>`;
                      } else if(type === "active") {
                          btnHtml = `<span class="text-success fw-bold">å¾…ä»‹ç´¹</span>`;
                      } else {
                          rowClass += " arrived";
                          btnHtml = `<span class="text-muted">å·²å®Œæˆ</span>`;
                      }

                      html += `<div class="${rowClass}" id="card-${item.rowIndex}">
                          <div class="info"><span class="job">${item.title}</span><span class="name">${item.name}</span></div>
                          <div>${btnHtml}</div>
                        </div>`;
                  });
              }
          });
      }
      html += `</div>`;
      return html;
  }

  function filterList() { renderLists(); }

  // ğŸ”¥ é˜²é–ƒçˆæ ¸å¿ƒ + æŒ‰éˆ•ç«‹å³åæ‡‰
  function toggleStatus(rowIndex, type) {
    if(isProcessing) return;
    
    // 1. ç«‹å³é–å®š
    if(timer) clearInterval(timer);
    isProcessing = true;

    // 2. è®“æŒ‰éˆ•è®Šç°ï¼Œé¡¯ç¤º "..." (ä½¿ç”¨è€…å›é¥‹)
    var btn = document.getElementById('btn-' + rowIndex);
    if(btn) { btn.innerText = "..."; btn.disabled = true; }

    // 3. æœ¬åœ°é åˆ¤æ›´æ–°
    var target = allGuests.find(g => g.rowIndex == rowIndex);
    if (target) {
        if (type === "CHECKIN") { 
            target.status = "å¾…ä»‹ç´¹"; 
            var now = new Date(); target.checkInTime = now.toTimeString().split(' ')[0]; 
        } 
    }
    
    // 4. é‡ç¹ª (é€™æ™‚å€™å¡ç‰‡æœƒé£›åˆ°ä¸‹ä¸€å€ï¼Œå› ç‚ºæ•¸æ“šå·²ç¶“è®Šäº†)
    saveCollapseState();
    renderLists();

    // 5. ç™¼é€è«‹æ±‚ -> å»¶é²è§£é–
    fetch(API_URL, { method: "POST", body: JSON.stringify({ action: "receptionAction", rowIndex: rowIndex, type: type }) })
    .then(() => {
        setTimeout(() => {
            isProcessing = false;
            fetchData(); 
            startTimer(); 
        }, 2500);
    })
    .catch(() => { isProcessing = false; startTimer(); });
  }

  function addNew() {
    var title = document.getElementById('new-job').value;
    var name = document.getElementById('new-name').value;
    var level = document.getElementById('new-level').value; // å–å¾—é¸æ“‡çš„ç­‰ç´š
    if(!name) { alert("è«‹è¼¸å…¥å§“å"); return; }
    
    if(confirm(`ç¢ºèªæ–°å¢ä¸¦å ±åˆ°ï¼š\n${title} ${name} ï¼Ÿ`)) {
        var btn = document.querySelector('.btn-add'); var orgText = btn.innerText; btn.innerText = "..."; btn.disabled = true;
        
        fetch(API_URL, { method: "POST", body: JSON.stringify({ action: "guestCheckIn", title: title, name: name, level: level, isReception: true }) })
        .then(() => {
            alert("æ–°å¢æˆåŠŸï¼");
            document.getElementById('new-job').value=""; document.getElementById('new-name').value=""; 
            fetchData(); 
            btn.innerText = orgText; btn.disabled = false;
        });
    }
  }
</script>
</body>
</html>
