<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æ¥å¾…è™•å ±åˆ°ç³»çµ±</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    /* === æ‰‹æ©Ÿç‰ˆå„ªåŒ–ä»‹é¢ === */
    body { 
        background-color: #f0f2f5; 
        padding: 15px; 
        font-family: "Microsoft JhengHei", sans-serif; 
    }
    .container { 
        max-width: 600px; 
        margin: 0 auto; 
        background: white; 
        padding: 20px; 
        border-radius: 16px; 
        box-shadow: 0 4px 12px rgba(0,0,0,0.05); 
    }
    
    h3 { font-weight: 800; color: #333; margin-bottom: 20px; text-align: center; }

    /* æœå°‹æ¡† */
    .search-box { 
        margin-bottom: 20px; 
        border-radius: 12px; 
        padding: 12px; 
        border: 2px solid #ddd;
    }
    .search-box:focus { border-color: #2196f3; box-shadow: none; }

    /* åå–®åˆ—è¡¨ */
    #guest-list { 
        max-height: 50vh; /* é™åˆ¶é«˜åº¦è®“å®ƒå¯æ²å‹• */
        overflow-y: auto; 
        margin-bottom: 30px;
    }
    
    .guest-row { 
        padding: 15px; 
        border-bottom: 1px solid #f1f1f1; 
        display: flex; 
        justify-content: space-between; 
        align-items: center; 
        transition: background 0.2s;
    }
    .guest-row:last-child { border-bottom: none; }
    
    /* å§“åèˆ‡è·ç¨± */
    .guest-info { font-size: 20px; font-weight: bold; color: #000; }
    .guest-job { font-size: 15px; color: #666; display: block; margin-bottom: 2px; }
    
    /* å ±åˆ°æŒ‰éˆ• */
    .btn-arrived { 
        background: #0d6efd; 
        color: white; 
        border: none; 
        padding: 8px 20px; 
        border-radius: 50px; 
        font-weight: bold; 
        font-size: 16px;
        transition: all 0.2s;
    }
    .btn-arrived:active { transform: scale(0.95); }
    .btn-arrived:disabled { background: #ccc; cursor: not-allowed; }

    /* ç¾å ´è£œç™»å€å¡Š */
    .add-box { 
        background: #fff3cd; 
        padding: 20px; 
        border-radius: 16px; 
        border: 1px dashed #ffc107; 
    }
    .add-title { font-weight: bold; color: #856404; margin-bottom: 10px; display: block;}
    
    /* è¼‰å…¥ä¸­å‹•ç•« */
    .loading { text-align: center; color: #999; padding: 20px; }
  </style>
</head>
<body>

<div class="container">
  <h3>ğŸ“‹ æ¥å¾…è™•å ±åˆ°ç³»çµ±</h3>
  
  <input type="text" id="search" class="form-control form-control-lg search-box" placeholder="ğŸ” è¼¸å…¥å§“åå¿«é€Ÿæœå°‹..." onkeyup="filterList()">
  
  <div id="guest-list">
    <div class="loading">æ­£åœ¨è®€å–åå–®...</div>
  </div>

  <div class="add-box">
    <span class="add-title">â• ç¾å ´è£œç™» (åå–®å¤–è²´è³“)</span>
    <div class="row g-2">
      <div class="col-4">
        <input type="text" id="new-job" class="form-control" placeholder="è·ç¨±">
      </div>
      <div class="col-5">
        <input type="text" id="new-name" class="form-control" placeholder="å§“å">
      </div>
      <div class="col-3">
        <button onclick="addNew()" class="btn btn-warning w-100 fw-bold">å ±åˆ°</button>
      </div>
    </div>
  </div>
</div>

<script>
  // âš ï¸âš ï¸âš ï¸ è«‹å‹™å¿…æ›æˆä½ æœ€æ–°çš„ GAS API ç¶²å€ âš ï¸âš ï¸âš ï¸
  // âš ï¸ è¨˜å¾— GAS éƒ¨ç½²æ¬Šé™è¦è¨­ç‚ºã€Œä»»ä½•äºº (Anyone)ã€ï¼Œå¦å‰‡ GitHub æœƒé€£ä¸ä¸Š
  const API_URL = "https://script.google.com/macros/s/AKfycbw62YC7Q03CC-YL_UyBKR4JXfP_cU3OIiswA9LlHhKLIS1LJrCg2DBT441eaE880C05BA/exec";
  
  var allGuests = []; // å­˜æ”¾æ‰€æœ‰ä¸‹è¼‰çš„åå–®

  // 1. å•Ÿå‹•æ™‚è®€å–åå–®
  function loadList() {
    var listDiv = document.getElementById('guest-list');
    
    // é€é POST è«‹æ±‚å‘¼å«å¾Œç«¯
    // æ³¨æ„ï¼šGitHub Pages æ˜¯å¤–éƒ¨ç¶²ç«™ï¼Œç›´æ¥ç”¨ fetch POST æ˜¯æœ€ç©©å®šçš„æ–¹å¼
    fetch(API_URL, { 
        method: "POST", 
        body: JSON.stringify({ action: "getAllList" }) 
    })
    .then(res => res.json())
    .then(json => {
      allGuests = json.data;
      renderList(allGuests);
    })
    .catch(err => {
      listDiv.innerHTML = "<div class='text-danger text-center'>é€£ç·šå¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯æˆ– GAS è¨­å®š</div>";
      console.error(err);
    });
  }

  // 2. æ¸²æŸ“åˆ—è¡¨ (åªé¡¯ç¤ºæœªå ±åˆ°çš„äºº)
  function renderList(data) {
    var list = document.getElementById('guest-list');
    list.innerHTML = "";
    
    // éæ¿¾ï¼šåªé¡¯ç¤ºç‹€æ…‹ç‚º "æœªå ±åˆ°" çš„äºº
    var filtered = data.filter(d => d.status === "æœªå ±åˆ°");
    
    if(filtered.length === 0) { 
        list.innerHTML = "<div class='text-center p-4 text-muted'>æ²’æœ‰æœªå ±åˆ°çš„ä¾†è³“<br>(è«‹ä½¿ç”¨æœå°‹æˆ–ç¾å ´è£œç™»)</div>"; 
        return;
    }
    
    filtered.forEach(item => {
      var html = `
        <div class="guest-row" id="row-${item.rowIndex}">
          <div>
            <span class="guest-job">${item.title}</span>
            <span class="guest-info">${item.name}</span>
          </div>
          <button class="btn-arrived" onclick="markArrived(this, ${item.rowIndex}, '${item.name}')">å ±åˆ°</button>
        </div>`;
      list.innerHTML += html;
    });
  }

  // 3. æœå°‹éæ¿¾åŠŸèƒ½
  function filterList() {
    var keyword = document.getElementById('search').value.toLowerCase().trim();
    
    // å¦‚æœæ²’æœ‰é—œéµå­—ï¼Œå°±é‡æ–°é¡¯ç¤ºæ‰€æœ‰æœªå ±åˆ°çš„äºº
    if(!keyword) { 
        renderList(allGuests); 
        return; 
    }
    
    // æœ‰é—œéµå­—æ™‚ï¼šæœå°‹å§“åæˆ–è·ç¨±ï¼Œä¸”ç‹€æ…‹å¿…é ˆæ˜¯ "æœªå ±åˆ°"
    var filteredResults = allGuests.filter(d => 
      (d.name.toLowerCase().includes(keyword) || d.title.toLowerCase().includes(keyword)) && d.status === "æœªå ±åˆ°"
    );
    
    var list = document.getElementById('guest-list');
    list.innerHTML = "";
    
    if(filteredResults.length === 0) {
        list.innerHTML = "<div class='text-center p-3 text-muted'>æ‰¾ä¸åˆ°ç›¸é—œåå–®ï¼Œè«‹ä½¿ç”¨ä¸‹æ–¹è£œç™»</div>";
        return;
    }

    filteredResults.forEach(item => {
      var html = `
        <div class="guest-row" id="row-${item.rowIndex}">
          <div>
            <span class="guest-job">${item.title}</span>
            <span class="guest-info">${item.name}</span>
          </div>
          <button class="btn-arrived" onclick="markArrived(this, ${item.rowIndex}, '${item.name}')">å ±åˆ°</button>
        </div>`;
      list.innerHTML += html;
    });
  }

  // 4. æŒ‰ä¸‹å ±åˆ°
  function markArrived(btn, rowIndex, name) {
    // UI ç«‹å³å›é¥‹ï¼šæŒ‰éˆ•è®Šè‰²ä¸¦åœç”¨
    btn.disabled = true; 
    btn.innerText = "å·²é€å‡º...";
    btn.style.backgroundColor = "#6c757d"; // è®Šç°è‰²

    fetch(API_URL, { 
        method: "POST", 
        body: JSON.stringify({ action: "markArrived", rowIndex: rowIndex }) 
    })
    .then(res => res.json())
    .then(json => {
        if(json.status === "success") {
            // æˆåŠŸå¾Œï¼Œè®“è©²åˆ—æ·¡å‡ºæ¶ˆå¤± (è¦–è¦ºæ•ˆæœ)
            var row = document.getElementById(`row-${rowIndex}`);
            row.style.opacity = "0.5";
            row.style.background = "#e8f5e9";
            btn.innerText = "âœ… å®Œæˆ";
            
            // æ›´æ–°æœ¬åœ°è³‡æ–™ (é¿å…æœå°‹æ™‚åˆè·‘å‡ºä¾†)
            var target = allGuests.find(g => g.rowIndex == rowIndex);
            if(target) target.status = "å¾…ä»‹ç´¹";
            
            // 1ç§’å¾Œè‡ªå‹•é‡æ–°æ•´ç†åˆ—è¡¨ (ç§»é™¤è©²åˆ—)
            setTimeout(() => {
                // å¦‚æœæœå°‹æ¡†æœ‰å­—ï¼Œå°±ç¶­æŒæœå°‹ç‹€æ…‹
                filterList(); 
            }, 800);
        } else {
            alert("éŒ¯èª¤ï¼š" + json.message);
            btn.disabled = false;
            btn.innerText = "å ±åˆ°";
            btn.style.backgroundColor = "#0d6efd";
        }
    });
  }

  // 5. ç¾å ´è£œç™»
  function addNew() {
    var title = document.getElementById('new-job').value;
    var name = document.getElementById('new-name').value;
    if(!name) { alert("è«‹è¼¸å…¥å§“åï¼"); return; }
    
    if(confirm(`ç¢ºèªæ–°å¢ï¼š\n${title} ${name}\n\nä¸¦ç›´æ¥æ¨™ç¤ºç‚ºã€Œå·²å ±åˆ°ã€å—ï¼Ÿ`)) {
        // UI é–å®šé˜²æ­¢é‡è¤‡æŒ‰
        var btn = document.querySelector('.btn-warning');
        var orgText = btn.innerText;
        btn.disabled = true; btn.innerText = "è™•ç†ä¸­...";

        fetch(API_URL, { 
            method: "POST", 
            body: JSON.stringify({ action: "checkIn", title: title, name: name }) 
        })
        .then(() => {
            alert(`ğŸ‰ ${name} å ±åˆ°æˆåŠŸï¼\nè³‡æ–™å·²å‚³é€è‡³ä¸»æŒäººæ§å°ã€‚`);
            // æ¸…ç©ºè¼¸å…¥æ¡†
            document.getElementById('new-job').value = "";
            document.getElementById('new-name').value = "";
            
            // æ¢å¾©æŒ‰éˆ•
            btn.disabled = false; btn.innerText = orgText;
            
            // é‡æ–°è®€å–åå–® (ç¢ºä¿åŒæ­¥)
            loadList();
        });
    }
  }

  // ç¨‹å¼å•Ÿå‹•
  loadList();
</script>

</body>
</html>
